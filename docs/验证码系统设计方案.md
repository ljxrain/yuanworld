# 验证码系统设计方案

## 🎯 设计目标

防止用户恶意注册马甲账号，保护系统资源：
1. **防止批量注册**：防止用户无限注册获取免费预览次数
2. **防止刷佣金**：防止用户自己给自己刷分销佣金
3. **确保真实用户**：通过手机号或邮箱验证确保用户真实性
4. **限制注册频率**：同一手机号/邮箱有冷却时间

---

## 📱 注册方式

### 方案：手机号或邮箱二选一（必须验证其中一个）

**用户可以选择：**
- **手机号注册**：手机号 + 短信验证码 + 密码（推荐）
- **邮箱注册**：邮箱 + 邮件验证码 + 密码

**注意**：
- 必须至少验证一个（手机号或邮箱）
- 可以同时提供两者，但至少验证一个
- 验证码有效期：5分钟
- 同一手机号/邮箱每天最多发送5次验证码

---

## 🗄️ 数据库设计

### 1. 验证码记录表 `verification_codes`

```sql
CREATE TABLE verification_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- 验证码信息
    code VARCHAR(6) NOT NULL,                    -- 6位数字验证码
    type VARCHAR(20) NOT NULL,                   -- 'sms' 或 'email'
    target VARCHAR(100) NOT NULL,                -- 手机号或邮箱

    -- 用途
    purpose VARCHAR(50) NOT NULL,                -- 'register', 'login', 'reset_password'

    -- 状态
    is_used BOOLEAN DEFAULT FALSE,               -- 是否已使用
    used_at TIMESTAMP,                           -- 使用时间

    -- 有效期
    expires_at TIMESTAMP NOT NULL,               -- 过期时间（5分钟后）

    -- IP和设备信息
    ip_address VARCHAR(45),                      -- 请求IP
    user_agent TEXT,                             -- 浏览器信息

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 索引
    INDEX idx_target_type (target, type),
    INDEX idx_code_target (code, target),
    INDEX idx_expires_at (expires_at)
);
```

### 2. 修改用户表 `users`

```sql
ALTER TABLE users
ADD COLUMN phone VARCHAR(20) UNIQUE,           -- 手机号（唯一）
ADD COLUMN phone_verified BOOLEAN DEFAULT FALSE,  -- 手机号是否已验证
ADD COLUMN email_verified BOOLEAN DEFAULT FALSE,  -- 邮箱是否已验证
ADD COLUMN registration_type VARCHAR(20);      -- 'phone' 或 'email'
```

---

## 🔐 短信验证码服务商选择

### 推荐方案：阿里云短信服务

**为什么选择阿里云：**
- 价格便宜：0.045元/条（套餐价更低）
- 稳定可靠：到达率99%以上
- 国内覆盖好
- 开通简单

**备选方案：**
- 腾讯云短信
- 华为云短信
- 网易云信

### 成本估算

- 每条短信：¥0.045
- 每天100次注册 = ¥4.5/天 = ¥135/月
- 建议购买套餐：10万条 = ¥3500（¥0.035/条）

---

## 📧 邮箱验证码服务

### 方案：使用阿里云邮件推送或自建SMTP

**阿里云邮件推送：**
- 免费额度：每天200封
- 付费价格：0.0002元/封
- 适合小规模使用

**自建SMTP（推荐）：**
- 使用QQ企业邮箱或163邮箱
- 完全免费
- 需要开启SMTP授权

---

## 🔄 注册流程

### 完整流程图

```
用户打开注册页面
    ↓
选择注册方式（手机号/邮箱）
    ↓
输入手机号/邮箱
    ↓
点击"获取验证码"按钮
    ↓
后端验证：
  - 检查是否已注册
  - 检查发送频率限制
  - 生成6位随机数字
  - 发送短信/邮件
  - 保存到数据库
    ↓
用户收到验证码
    ↓
用户输入：
  - 验证码
  - 用户名
  - 密码
  - 邀请码（可选）
    ↓
点击"注册"按钮
    ↓
后端验证：
  - 验证码是否正确
  - 验证码是否过期
  - 验证码是否已使用
  - 用户名是否重复
    ↓
创建用户账号
标记验证码已使用
标记手机号/邮箱已验证
如果有邀请码则建立邀请关系
    ↓
注册成功，自动登录
```

---

## 🛡️ 安全措施

### 1. 发送频率限制

```javascript
// 同一手机号/邮箱
- 60秒内只能发送1次
- 1小时内最多5次
- 24小时内最多10次

// 同一IP
- 1分钟内最多3次
- 1小时内最多20次
```

### 2. 验证码规则

```javascript
- 长度：6位数字
- 有效期：5分钟
- 一次性：使用后立即失效
- 不可重复使用
```

### 3. 防刷机制

```javascript
- 滑动验证码（前端）
- IP黑名单
- 设备指纹识别
- 异常行为检测
```

---

## 📝 API接口设计

### 1. 发送验证码

**POST** `/api/auth/send-verification-code`

**请求参数：**
```json
{
  "type": "sms",              // 'sms' 或 'email'
  "target": "13800138000",    // 手机号或邮箱
  "purpose": "register"       // 'register', 'login', 'reset_password'
}
```

**响应：**
```json
{
  "success": true,
  "message": "验证码已发送",
  "data": {
    "expires_in": 300,        // 有效期（秒）
    "can_resend_in": 60       // 可重新发送倒计时（秒）
  }
}
```

**错误响应：**
```json
{
  "success": false,
  "message": "发送过于频繁，请60秒后再试"
}
```

---

### 2. 注册（带验证码）

**POST** `/api/auth/register`

**请求参数：**
```json
{
  "registration_type": "phone",   // 'phone' 或 'email'
  "phone": "13800138000",         // 手机号（type=phone时必填）
  "email": "user@example.com",    // 邮箱（type=email时必填）
  "verification_code": "123456",  // 验证码
  "username": "testuser",         // 用户名
  "password": "123456",           // 密码
  "inviter_code": "ABC12345"      // 邀请码（可选）
}
```

**响应：**
```json
{
  "success": true,
  "message": "注册成功",
  "data": {
    "user": {
      "id": "uuid",
      "username": "testuser",
      "phone": "13800138000",
      "phone_verified": true
    },
    "token": "jwt_token"
  }
}
```

---

## 🎨 前端界面设计

### 注册表单字段

```html
<!-- 选择注册方式 -->
<div class="registration-type">
  <button class="type-btn active" data-type="phone">手机号注册</button>
  <button class="type-btn" data-type="email">邮箱注册</button>
</div>

<!-- 手机号注册 -->
<div id="phoneRegistration">
  <input type="tel" placeholder="请输入手机号" maxlength="11" />
  <div class="verification-code-group">
    <input type="text" placeholder="请输入验证码" maxlength="6" />
    <button class="send-code-btn">获取验证码</button>
  </div>
  <input type="text" placeholder="请输入用户名" />
  <input type="password" placeholder="请输入密码" />
  <input type="text" placeholder="邀请码（可选）" />
  <button class="register-btn">注册</button>
</div>

<!-- 邮箱注册 -->
<div id="emailRegistration" style="display:none;">
  <input type="email" placeholder="请输入邮箱" />
  <div class="verification-code-group">
    <input type="text" placeholder="请输入验证码" maxlength="6" />
    <button class="send-code-btn">获取验证码</button>
  </div>
  <input type="text" placeholder="请输入用户名" />
  <input type="password" placeholder="请输入密码" />
  <input type="text" placeholder="邀请码（可选）" />
  <button class="register-btn">注册</button>
</div>
```

### 验证码倒计时

```javascript
let countdown = 60;
const timer = setInterval(() => {
  countdown--;
  sendCodeBtn.textContent = `${countdown}秒后重试`;
  if (countdown <= 0) {
    clearInterval(timer);
    sendCodeBtn.disabled = false;
    sendCodeBtn.textContent = '重新获取';
  }
}, 1000);
```

---

## 🔧 实现步骤

### 第一阶段：基础功能
1. ✅ 创建数据库表
2. ✅ 修改用户表结构
3. ✅ 实现验证码生成和存储
4. ✅ 实现邮箱验证码发送（先做邮箱，成本低）
5. ✅ 修改注册API支持验证码
6. ✅ 修改前端注册页面

### 第二阶段：短信功能
1. ⏳ 注册阿里云短信服务
2. ⏳ 配置短信模板
3. ⏳ 实现短信验证码发送
4. ⏳ 测试短信发送

### 第三阶段：安全加固
1. ⏳ 添加频率限制
2. ⏳ 添加IP黑名单
3. ⏳ 添加滑动验证码
4. ⏳ 异常行为监控

---

## 💰 成本估算

### 邮件验证码
- **免费方案**：自建SMTP，完全免费
- **付费方案**：阿里云邮件推送，前200封/天免费

### 短信验证码
- **开发测试**：阿里云提供测试额度
- **正式运营**：
  - 每天100次注册 = ¥4.5
  - 每月3000次 = ¥135
  - 建议购买套餐降低成本

---

## 🎯 下一步计划

1. 先实现**邮箱验证码**（免费，无成本）
2. 测试通过后再实现**短信验证码**
3. 逐步添加安全防护措施

这样可以快速上线基础功能，同时控制成本。

---

## 📌 注意事项

1. **验证码明文存储问题**：考虑到需要验证，验证码以明文存储在数据库，但设置5分钟过期
2. **短信轰炸防护**：必须严格限制发送频率
3. **成本控制**：监控每日短信发送量，设置告警
4. **备用方案**：邮箱验证码作为备用注册方式
