<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«‹å³åˆ›ä½œ - åšä¸–ç•Œ</title>
    <style>
        :root { --main-color: #90EE90; --dark-bg: #121212; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--dark-bg); color: #fff; line-height: 1.6; }
        
        /* å¯¼èˆªæ  */
        nav { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); padding: 15px 0; border-bottom: 1px solid rgba(144,238,144,0.2); }
        .nav-content { max-width: 1400px; margin: 0 auto; padding: 0 40px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; background: linear-gradient(135deg, #90EE90, #37B679); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .nav-links { display: flex; gap: 30px; align-items: center; }
        .nav-link { color: #fff; font-weight: 500; text-decoration: none; transition: color 0.3s; }
        .nav-link:hover { color: #90EE90; }
        .user-info { color: var(--main-color); }
        
        .container { max-width: 1200px; margin: 80px auto 40px; padding: 40px 20px; }
       
        /* æ¨¡å¼é€‰æ‹© */
        .mode-selector { display: flex; gap: 30px; justify-content: center; margin-bottom: 50px; }
        .mode-card { flex: 1; max-width: 400px; padding: 40px; background: linear-gradient(135deg, #1a1a1a, #252525); border-radius: 20px; border: 3px solid #333; cursor: pointer; transition: all 0.4s; text-align: center; }
        .mode-card:hover { transform: translateY(-8px); border-color: rgba(144,238,144,0.5); }
        .mode-card.selected { border-color: var(--main-color); background: linear-gradient(135deg, rgba(144,238,144,0.1), rgba(55,182,121,0.1)); box-shadow: 0 10px 40px rgba(144,238,144,0.3); }
        .mode-icon { font-size: 4rem; margin-bottom: 20px; }
        .mode-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 15px; color: var(--main-color); }
        .mode-desc { opacity: 0.8; font-size: 1.05rem; line-height: 1.8; }
        .mode-steps { margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; text-align: left; font-size: 0.95rem; opacity: 0.7; }
        
        /* å†…å®¹åŒºåŸŸ */
        .creation-area { display: none; animation: fadeIn 0.5s; }
        .creation-area.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section { background: #1a1a1a; border-radius: 20px; padding: 40px; margin-bottom: 30px; border: 2px solid #333; }
        .section-title { font-size: 1.8rem; margin-bottom: 10px; color: var(--main-color); display: flex; align-items: center; gap: 10px; }
        .section-desc { opacity: 0.7; margin-bottom: 30px; font-size: 1.05rem; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-box { border: 3px dashed #444; border-radius: 15px; padding: 50px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.02); }
        .upload-box:hover { border-color: var(--main-color); background: rgba(144,238,144,0.05); }
        .upload-box.has-file { border-color: var(--main-color); background: rgba(144,238,144,0.1); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
        .upload-text { font-size: 1.1rem; margin-bottom: 10px; }
        .upload-hint { font-size: 0.9rem; opacity: 0.6; }
        .upload-input { display: none; }
        .upload-preview { margin-top: 20px; text-align: center; }
        .upload-preview img { max-width: 100%; max-height: 300px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .file-name { margin-top: 15px; color: var(--main-color); font-weight: 500; }
        
        /* æ¨¡æ¿ç½‘æ ¼ */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .template-card { aspect-ratio: 2/3; border-radius: 15px; overflow: hidden; position: relative; cursor: pointer; transition: all 0.3s; border: 3px solid transparent; background: #222; }
        .template-card:hover { transform: scale(1.05); }
        .template-card.selected { border-color: var(--main-color); box-shadow: 0 0 30px rgba(144,238,144,0.6); }
        .template-card img { width: 100%; height: 100%; object-fit: cover; }
        .template-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }
        .template-name { font-weight: 600; font-size: 0.95rem; }
        .template-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; margin-top: 5px; }
        .badge-vip { background: gold; color: #111; }
        
        /* è¡¨å• */
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 1.1rem; }
        .form-group textarea { width: 100%; min-height: 120px; padding: 15px; border: 2px solid #444; border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 1rem; font-family: inherit; resize: vertical; }
        .form-group textarea:focus { outline: none; border-color: var(--main-color); }
        
        /* æŒ‰é’® */
        .btn { padding: 16px 40px; border: none; border-radius: 30px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, #90EE90, #37B679); color: #111; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(144,238,144,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #333; color: #fff; }
        .btn-secondary:hover { background: #444; }
        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { text-align: center; padding: 60px 20px; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--main-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-container { text-align: center; }
        .preview-image { max-width: 600px; margin: 0 auto 30px; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .preview-image img { width: 100%; display: block; }
        .preview-info { background: rgba(144,238,144,0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px; }
        .preview-info p { margin: 10px 0; font-size: 1.05rem; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a1a; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; border: 2px solid var(--main-color); }
        .modal-title { font-size: 1.8rem; margin-bottom: 20px; color: var(--main-color); }
        .form-input { width: 100%; padding: 12px; border: 2px solid #333; border-radius: 8px; background: #222; color: #fff; font-size: 1rem; margin-bottom: 15px; }
        .form-input:focus { outline: none; border-color: var(--main-color); }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        /* è¿›åº¦æ­¥éª¤ */
        .progress-step { display: flex; gap: 15px; padding: 15px; margin-bottom: 15px; background: rgba(255,255,255,0.03); border-radius: 10px; border-left: 4px solid #333; transition: all 0.3s; }
        .progress-step.processing { border-left-color: #90EE90; background: rgba(144,238,144,0.1); }
        .progress-step.completed { border-left-color: #90EE90; background: rgba(144,238,144,0.05); opacity: 0.7; }
        .progress-step.failed { border-left-color: #ff6b6b; background: rgba(255,107,107,0.1); }
        
        .step-icon { font-size: 2rem; min-width: 50px; text-align: center; }
        .progress-step.processing .step-icon { animation: pulse 1.5s ease-in-out infinite; }
        .progress-step.completed .step-icon::before { content: 'âœ…'; }
        .progress-step.failed .step-icon::before { content: 'âŒ'; }
        
        .step-content { flex: 1; }
        .step-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; color: var(--main-color); }
        .step-desc { font-size: 0.9rem; opacity: 0.7; margin-bottom: 5px; }
        .step-status { font-size: 0.85rem; color: #90EE90; }
        .progress-step.failed .step-status { color: #ff6b6b; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Tab Styles */
        .template-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
        }
        .tab-btn {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background: none;
            color: #fff;
            opacity: 0.6;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            opacity: 1;
            color: var(--main-color);
        }
        .tab-btn.active {
            opacity: 1;
            color: var(--main-color);
            border-bottom-color: var(--main-color);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav>
        <div class="nav-content">
            <a href="/yuan/index.html" class="logo">åšä¸–ç•Œ AIç”Ÿå›¾</a>
            <div class="nav-links">
                <a href="/yuan/index.html" class="nav-link">é¦–é¡µ</a>
                <a href="/yuan/gallery.html" class="nav-link">æ¨¡æ¿ä¸­å¿ƒ</a>
                <a href="/yuan/before-after.html" class="nav-link">æ•ˆæœå±•ç¤º</a>
                <a href="/yuan/tech-pricing.html" class="nav-link">ä»·æ ¼</a>
                <a href="/yuan/user-center.html" id="userInfo" class="nav-link hidden" style="color: var(--main-color);">
                    ğŸ‘¤ <span id="username"></span>
                </a>
                <button id="loginBtn" class="btn-secondary" onclick="showLoginModal()" style="padding: 8px 20px; font-size: 0.95rem;">ç™»å½•/æ³¨å†Œ</button>
                <button id="logoutBtn" class="btn-secondary hidden" onclick="logout()" style="padding: 8px 20px; font-size: 0.95rem;">é€€å‡º</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <!-- æ¨¡å¼é€‰æ‹© -->
        <div id="modeSelection">
            <h1 class="text-center" style="font-size: 2.5rem; margin-bottom: 20px;">é€‰æ‹©åˆ›ä½œæ¨¡å¼</h1>
            <p class="text-center" style="opacity: 0.7; margin-bottom: 50px; font-size: 1.1rem;">é€‰æ‹©é€‚åˆä½ çš„æ–¹å¼ï¼Œå¼€å§‹AIåˆ›ä½œä¹‹æ—…</p>
            
            <div class="mode-selector">
                <!-- æ¨¡æ¿æ¨¡å¼ -->
                <div class="mode-card" onclick="selectMode('template')">
                    <div class="mode-icon">ğŸ¨</div>
                    <div class="mode-title">æ¨¡æ¿æ¨¡å¼</div>
                    <div class="mode-desc">
                        ä»ç²¾é€‰æ¨¡æ¿ä¸­é€‰æ‹©å–œæ¬¢çš„é£æ ¼<br>
                        è½»æ¾ä¸Šæ‰‹ï¼Œæ•ˆæœå‡ºä¼—
                    </div>
                    <div class="mode-steps">
                        <strong>æµç¨‹ï¼š</strong><br>
                        1ï¸âƒ£ é€‰æ‹©æ¨¡æ¿<br>
                        2ï¸âƒ£ ä¸Šä¼ ç…§ç‰‡<br>
                        3ï¸âƒ£ AIè‡ªåŠ¨ç”Ÿæˆ
                </div>
            </div>
            
                <!-- è‡ªç”±æ¨¡å¼ -->
                <div class="mode-card" onclick="selectMode('freestyle')">
                    <div class="mode-icon">âœ¨</div>
                    <div class="mode-title">è‡ªç”±æ¨¡å¼</div>
                    <div class="mode-desc">
                        è‡ªç”±å‘æŒ¥åˆ›æ„ï¼Œæ‰“é€ ç‹¬ç‰¹é£æ ¼<br>
                        ä¸Šä¼ å‚è€ƒå›¾ï¼Œè‡ªå®šä¹‰æ•ˆæœ
                    </div>
                    <div class="mode-steps">
                        <strong>æµç¨‹ï¼š</strong><br>
                        1ï¸âƒ£ ä¸Šä¼ ä½ çš„ç…§ç‰‡<br>
                        2ï¸âƒ£ ä¸Šä¼ å‚è€ƒå›¾+æè¿°<br>
                        3ï¸âƒ£ AIåˆ›æ„ç”Ÿæˆ
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡æ¿æ¨¡å¼åˆ›ä½œåŒº -->
        <div id="templateMode" class="creation-area">
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="backToModeSelection()">â† è¿”å›é€‰æ‹©æ¨¡å¼</button>
            </div>
            
            <!-- æ­¥éª¤1ï¼šé€‰æ‹©æ¨¡æ¿ -->
            <div id="templateStep1" class="section">
                <h2 class="section-title">
                    <span>1ï¸âƒ£</span>
                    <span>é€‰æ‹©ä½ å–œæ¬¢çš„æ¨¡æ¿</span>
                </h2>
                <p class="section-desc">ä»æˆ‘ä»¬ç²¾é€‰çš„é£æ ¼æ¨¡æ¿ä¸­é€‰æ‹©ä¸€ä¸ª</p>
                
                <div class="template-tabs">
                    <button class="tab-btn active" onclick="displayTemplates('ç”Ÿæ´»ç…§')">ç”Ÿæ´»ç…§</button>
                    <button class="tab-btn" onclick="displayTemplates('æƒ…ä¾£ç…§')">æƒ…ä¾£ç…§</button>
                    <button class="tab-btn" onclick="displayTemplates('å©šçº±ç…§')">å©šçº±ç…§</button>
                </div>

                <div class="template-grid" id="templateGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½æ¨¡æ¿ä¸­...</p>
        </div>
    </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="templateNextBtn" onclick="templateNext()" disabled>
                        ä¸‹ä¸€æ­¥ï¼šä¸Šä¼ ç…§ç‰‡ â†’
                    </button>
                </div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šä¸Šä¼ ç…§ç‰‡ -->
            <div id="templateStep2" class="section hidden">
                <h2 class="section-title">
                    <span>2ï¸âƒ£</span>
                    <span>ä¸Šä¼ ä½ çš„ç…§ç‰‡</span>
                </h2>
                <p class="section-desc">ä¸Šä¼ ä¸€å¼ æ¸…æ™°çš„ç…§ç‰‡ï¼ŒAIå°†æ ¹æ®ä½ é€‰æ‹©çš„æ¨¡æ¿é£æ ¼è¿›è¡Œåˆ›ä½œ</p>
                <p class="section-desc" style="color: #ff6600; font-size: 1.1rem; font-weight: bold; margin-top: 12px; text-shadow: 0 0 10px rgba(255,102,0,0.3);">ğŸ“Œ ç…§ç‰‡è¦æ±‚ï¼šâœ“ æ­£é¢æ¸…æ™°å¤§å¤´ç…§ âœ“ äº”å®˜å®Œæ•´å¯è§ âœ“ å…‰çº¿å……è¶³ âœ— ä¸è¦ä¾§è„¸/æˆ´å¢¨é•œ/æ¨¡ç³Šç…§</p>
                
                <div class="upload-box" onclick="document.getElementById('templateUserImage').click()">
                    <div class="upload-icon">ğŸ“¸</div>
                    <div class="upload-text">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div>
                    <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                    <input type="file" id="templateUserImage" class="upload-input" accept="image/*" onchange="handleTemplateUserImage(this)">
                    <div id="templateUserPreview" class="upload-preview hidden"></div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="templateBack()">â† è¿”å›é€‰æ‹©æ¨¡æ¿</button>
                    <button class="btn btn-primary" id="templateGenerateBtn" onclick="generateWithTemplate()" disabled>
                        ğŸ¨ å¼€å§‹ç”Ÿæˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- è‡ªç”±æ¨¡å¼åˆ›ä½œåŒº -->
        <div id="freestyleMode" class="creation-area">
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="backToModeSelection()">â† è¿”å›é€‰æ‹©æ¨¡å¼</button>
            </div>
            
            <div class="section">
                <h2 class="section-title">
                    <span>âœ¨</span>
                    <span>è‡ªç”±åˆ›ä½œ</span>
                </h2>
                <p class="section-desc">ä¸Šä¼ ä½ çš„ç…§ç‰‡å’Œå‚è€ƒå›¾ï¼Œæè¿°æƒ³è¦çš„æ•ˆæœï¼Œè®©AIä¸ºä½ åˆ›ä½œ</p>
                
                <!-- ä¸Šä¼ ç”¨æˆ·ç…§ç‰‡ -->
                    <div class="form-group">
                    <label>1ï¸âƒ£ ä¸Šä¼ ä½ çš„ç…§ç‰‡</label>
                    <p style="color: #ff6600; font-size: 1.1rem; font-weight: bold; margin: 8px 0; text-shadow: 0 0 10px rgba(255,102,0,0.3);">ğŸ“Œ ç…§ç‰‡è¦æ±‚ï¼šâœ“ æ­£é¢æ¸…æ™°å¤§å¤´ç…§ âœ“ äº”å®˜å®Œæ•´å¯è§ âœ“ å…‰çº¿å……è¶³ âœ— ä¸è¦ä¾§è„¸/æˆ´å¢¨é•œ/æ¨¡ç³Šç…§</p>
                    <div class="upload-box" onclick="document.getElementById('freestyleUserImage').click()">
                        <div class="upload-icon">ğŸ“¸</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ ä½ çš„ç…§ç‰‡</div>
                        <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼</div>
                        <input type="file" id="freestyleUserImage" class="upload-input" accept="image/*" onchange="handleFreestyleUserImage(this)">
                        <div id="freestyleUserPreview" class="upload-preview hidden"></div>
                    </div>
                </div>
                
                <!-- ä¸Šä¼ å‚è€ƒå›¾ -->
                    <div class="form-group">
                    <label>2ï¸âƒ£ ä¸Šä¼ å‚è€ƒå›¾ï¼ˆå¶åƒç…§ç‰‡/é£æ ¼å‚è€ƒï¼‰</label>
                    <p style="color: #ff6600; font-size: 1.1rem; font-weight: bold; margin: 8px 0; text-shadow: 0 0 10px rgba(255,102,0,0.3);">ğŸ“Œ å¶åƒç…§ç‰‡è¦æ±‚ï¼šâœ“ é«˜æ¸…æ­£é¢åŠèº«ç…§ âœ“ æ¸…æ™°å¯è§ âœ“ å§¿æ€è‡ªç„¶</p>
                    <div class="upload-box" onclick="document.getElementById('freestyleIdolImage').click()">
                        <div class="upload-icon">ğŸŒŸ</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å‚è€ƒå›¾</div>
                        <div class="upload-hint">è¿™å¼ å›¾å°†ä½œä¸ºé£æ ¼å‚è€ƒ</div>
                        <input type="file" id="freestyleIdolImage" class="upload-input" accept="image/*" onchange="handleFreestyleIdolImage(this)">
                        <div id="freestyleIdolPreview" class="upload-preview hidden"></div>
                </div>
            </div>
            
                <!-- è¾“å…¥Prompt -->
                <div class="form-group">
                    <label>3ï¸âƒ£ æè¿°ä½ æƒ³è¦çš„æ•ˆæœ</label>
                    <textarea id="freestylePrompt" placeholder="ä¾‹å¦‚ï¼šä¸¤äººåæŒ‡ç›¸æ‰£ï¼Œè½»è½»é åœ¨ä¸€èµ·ï¼Œç›®å…‰æ·±æƒ…å¯¹è§†ã€‚æ­£é¢å¯¹é•œå¤´çš„åŠèº«åƒï¼Œè„¸éƒ¨å®Œå…¨ä¿æŒå‚è€ƒç…§ç‰‡ä¸€è‡´ï¼Œç”»é¢æµªæ¼«æ¸©é¦¨ã€‚" oninput="updateButtons()"></textarea>
        </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="freestyleGenerateBtn" onclick="generateFreestyle()" disabled>
                        ğŸ¨ å¼€å§‹åˆ›ä½œ
                    </button>
    </div>
            </div>
        </div>
        
        <!-- ç”Ÿæˆä¸­/ç»“æœå±•ç¤º -->
        <div id="resultArea" class="creation-area">
            <!-- ç”Ÿæˆä¸­ -->
            <div id="generating" class="section">
                <h2 style="text-align: center; color: var(--main-color); margin-bottom: 30px;">ğŸ¨ AIæ­£åœ¨åˆ›ä½œä¸­</h2>
                
                <!-- AIåˆ›ä½œåŠ¨ç”» -->
                <div id="aiAnimation" style="max-width: 500px; margin: 0 auto 40px; text-align: center;">
                    <div style="margin: 40px 0;">
                        <div class="ai-icon" style="font-size: 80px; animation: aiPulse 2s ease-in-out infinite;">ğŸ¨</div>
                    </div>
                    <p id="aiStatusText" style="font-size: 1.2rem; color: var(--main-color); font-weight: bold; margin-bottom: 15px;">AIæ­£åœ¨ä¸ºæ‚¨åˆ›ä½œ...</p>
                    <p style="font-size: 0.95rem; opacity: 0.8; margin-bottom: 20px;">è¯·ç¨å€™ç‰‡åˆ»ï¼Œç²¾å½©å³å°†å‘ˆç°</p>
                    
                    <!-- è¿›åº¦æ¡ -->
                    <div style="width: 100%; max-width: 400px; margin: 0 auto 15px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 20px; height: 8px; overflow: hidden;">
                            <div id="aiProgressBar" style="height: 100%; background: linear-gradient(90deg, #FF6B6B, #4ECDC4, #FFD93D); background-size: 200% 100%; border-radius: 20px; width: 0%; transition: width 0.5s ease; animation: progressShine 2s linear infinite;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.85rem; opacity: 0.7;">
                            <span id="progressPercent">0%</span>
                            <span id="progressTime">é¢„è®¡ 30-60 ç§’</span>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes aiPulse {
                        0%, 100% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.1); opacity: 0.8; }
                    }
                    @keyframes progressShine {
                        0% { background-position: 200% 0; }
                        100% { background-position: -200% 0; }
                    }
                    .progress-step { display: none !important; }
                </style>
                
                <!-- è¿›åº¦æ­¥éª¤ï¼ˆéšè—ä½†ä¿ç•™åŠŸèƒ½ï¼‰ -->
                <div style="max-width: 600px; margin: 0 auto; display: none;">
                    <div class="progress-step" id="step1">
                        <div class="step-icon">â³</div>
                        <div class="step-content">
                            <div class="step-title">1. å‡†å¤‡æ•°æ®</div>
                            <div class="step-desc">è·å–æ¨¡æ¿çš„Promptå’Œå¶åƒç…§ç‰‡</div>
                            <div class="step-status">ç­‰å¾…ä¸­...</div>
            </div>
                    </div>
                    
                    <div class="progress-step" id="step2">
                        <div class="step-icon">â³</div>
                        <div class="step-content">
                            <div class="step-title">2. ç»„åˆæ•°æ®</div>
                            <div class="step-desc">ç”¨æˆ·ç…§ç‰‡ + å¶åƒç…§ç‰‡ + Prompt</div>
                            <div class="step-status">ç­‰å¾…ä¸­...</div>
            </div>
        </div>

                    <div class="progress-step" id="step3">
                        <div class="step-icon">â³</div>
                        <div class="step-content">
                            <div class="step-title">3. å‘é€åˆ°è€å¼ API</div>
                            <div class="step-desc">https://api.laozhang.ai</div>
                            <div class="step-status">ç­‰å¾…ä¸­...</div>
                        </div>
                    </div>
                    
                    <div class="progress-step" id="step4">
                        <div class="step-icon">â³</div>
                        <div class="step-content">
                            <div class="step-title">4. AIæ¨¡å‹å¤„ç†</div>
                            <div class="step-desc">Nano Banana æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div>
                            <div class="step-status">ç­‰å¾…ä¸­...</div>
                        </div>
                    </div>
                    
                    <div class="progress-step" id="step5">
                        <div class="step-icon">â³</div>
                        <div class="step-content">
                            <div class="step-title">5. æ¥æ”¶ç»“æœ</div>
                            <div class="step-desc">è€å¼ APIè¿”å›ç”Ÿæˆçš„å›¾ç‰‡</div>
                            <div class="step-status">ç­‰å¾…ä¸­...</div>
                    </div>
                    </div>
                    
                    <div class="progress-step" id="step6">
                        <div class="step-icon">â³</div>
                        <div class="step-content">
                            <div class="step-title">6. ä¿å­˜å›¾ç‰‡</div>
                            <div class="step-desc">ä¿å­˜åˆ°æœåŠ¡å™¨å¹¶æ·»åŠ æ°´å°</div>
                            <div class="step-status">ç­‰å¾…ä¸­...</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px; opacity: 0.7; display: none;">
                    <p id="overallStatus">æ­£åœ¨å¤„ç†...</p>
                    </div>
                    </div>
            
            <!-- ç”ŸæˆæˆåŠŸ -->
            <div id="resultSuccess" class="section hidden">
                <h2 class="section-title text-center">
                    <span>ğŸ‰</span>
                    <span>åˆ›ä½œå®Œæˆï¼</span>
                </h2>
                
                <div class="preview-container">
                    <div class="preview-image">
                        <img id="resultImage" src="" alt="ç”Ÿæˆç»“æœ">
                </div>
                
                    <div class="preview-info">
                        <p>â±ï¸ ç”Ÿæˆè€—æ—¶ï¼š<strong id="processingTime">0</strong> ç§’</p>
                        <p>ğŸ å‰©ä½™å…è´¹é¢„è§ˆï¼š<strong id="remainingPreviews">0</strong> æ¬¡</p>
                        <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">
                            é¢„è§ˆå›¾ä¸ºæ°´å°ç‰ˆæœ¬ï¼Œä¸‹è½½é«˜æ¸…æ— æ°´å°ç‰ˆæœ¬éœ€ä»˜è´¹
                        </p>
                </div>
                
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="startNew()">ğŸ”„ é‡æ–°åˆ›ä½œ</button>
                        <button class="btn btn-primary" onclick="downloadHighQuality()">
                            ğŸ’ ä¸‹è½½é«˜æ¸…ç‰ˆ (Â¥5)
                        </button>
                    </div>
                </div>
            </div>
                
            <!-- ç”Ÿæˆå¤±è´¥ -->
            <div id="resultError" class="section hidden">
                <div class="text-center">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜”</div>
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;">ç”Ÿæˆå¤±è´¥</h2>
                    <p id="errorMessage" style="opacity: 0.7; margin-bottom: 30px;"></p>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="startNew()">â† è¿”å›é‡è¯•</button>
                    </div>
                </div>
            </div>
                </div>
            </div>
            
    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="authTitle">ç™»å½•</h2>
            
            <div id="loginForm">
                <input type="text" id="loginIdentifier" class="form-input" placeholder="ç”¨æˆ·åæˆ–é‚®ç®±">
                <input type="password" id="loginPassword" class="form-input" placeholder="å¯†ç ">
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeAuthModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                    </div>
                <p class="text-center" style="margin-top: 20px; opacity: 0.7;">
                    è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchToRegister()" style="color: var(--main-color);">ç«‹å³æ³¨å†Œ</a>
                </p>
                </div>
            
            <div id="registerForm" class="hidden">
                <input type="text" id="registerUsername" class="form-input" placeholder="ç”¨æˆ·åï¼ˆå¿…å¡«ï¼Œè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰">
                <input type="email" id="registerEmail" class="form-input" placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ï¼šuser@example.comï¼‰">
                <input type="password" id="registerPassword" class="form-input" placeholder="å¯†ç ï¼ˆå¿…å¡«ï¼Œè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰">
                <input type="password" id="registerPasswordConfirm" class="form-input" placeholder="ç¡®è®¤å¯†ç ">
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeAuthModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="register()">æ³¨å†Œ</button>
                </div>
                <p class="text-center" style="margin-top: 20px; opacity: 0.7;">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchToLogin()" style="color: var(--main-color);">ç«‹å³ç™»å½•</a>
                </p>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentMode = null; // 'template' or 'freestyle'
        let selectedTemplateId = null;
        let selectedTemplate = null;
        let templateUserImageFile = null;
        let freestyleUserImageFile = null;
        let freestyleIdolImageFile = null;
        let currentUser = null;
        let currentToken = null;
        let currentGenerationId = null;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–');
            checkLoginStatus();
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            currentToken = localStorage.getItem('token');

            if (!currentToken) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                console.log('âš ï¸ ç”¨æˆ·æœªç™»å½•');
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.user) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }

                currentUser = data.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', currentUser.username);
            } catch (error) {
                console.warn('ç™»å½•çŠ¶æ€å¤±æ•ˆï¼Œå·²è‡ªåŠ¨é€€å‡º:', error.message || error);
                logout();
                alert('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆæˆ–è´¦æˆ·ä¸å¯ç”¨ï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
            }
        }
        
        // é€‰æ‹©æ¨¡å¼
        function selectMode(mode) {
            if (!currentToken) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨åˆ›ä½œåŠŸèƒ½');
                showLoginModal();
                return;
            }
            
            console.log('ğŸ“ é€‰æ‹©æ¨¡å¼:', mode);
            currentMode = mode;
            
            // éšè—æ¨¡å¼é€‰æ‹©
            document.getElementById('modeSelection').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”çš„åˆ›ä½œåŒº
            if (mode === 'template') {
                document.getElementById('templateMode').classList.add('active');
                loadTemplates();
            } else {
                document.getElementById('freestyleMode').classList.add('active');
            }
        }
        
        // è¿”å›æ¨¡å¼é€‰æ‹©
        function backToModeSelection() {
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('templateMode').classList.remove('active');
            document.getElementById('freestyleMode').classList.remove('active');
            document.getElementById('resultArea').classList.remove('active');
            resetAll();
        }
        
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        function resetAll() {
            selectedTemplateId = null;
            selectedTemplate = null;
            templateUserImageFile = null;
            freestyleUserImageFile = null;
            freestyleIdolImageFile = null;
            currentGenerationId = null;
            
            // é‡ç½®UI
            document.getElementById('templateStep1').classList.remove('hidden');
            document.getElementById('templateStep2').classList.add('hidden');
            document.getElementById('templateUserPreview').classList.add('hidden');
            document.getElementById('freestyleUserPreview').classList.add('hidden');
            document.getElementById('freestyleIdolPreview').classList.add('hidden');
            document.getElementById('freestylePrompt').value = '';
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼ˆé‡è¦ï¼ï¼‰
            const templateUserInput = document.getElementById('templateUserImage');
            const freestyleUserInput = document.getElementById('freestyleUserImage');
            const freestyleIdolInput = document.getElementById('freestyleIdolImage');
            
            if (templateUserInput) templateUserInput.value = '';
            if (freestyleUserInput) freestyleUserInput.value = '';
            if (freestyleIdolInput) freestyleIdolInput.value = '';
            
            updateButtons();
        }
        
        // ========== æ¨¡æ¿æ¨¡å¼é€»è¾‘ ==========
        
        // ä»æ•°æ®åº“åŠ è½½çš„æ¨¡æ¿æ•°æ®
        let allTemplates = [];
        let templatesData = {
            "ç”Ÿæ´»ç…§": [],
            "æƒ…ä¾£ç…§": [],
            "å©šçº±ç…§": []
        };

        // ä»APIåŠ è½½æ¨¡æ¿
        async function loadTemplatesFromAPI() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                allTemplates = Array.isArray(data) ? data : (data.templates || []);
                
                // æŒ‰åˆ†ç±»æ•´ç†æ¨¡æ¿
                templatesData = {
                    "ç”Ÿæ´»ç…§": [],
                    "æƒ…ä¾£ç…§": [],
                    "å©šçº±ç…§": []
                };
                
                const categoryMap = {
                    'life': 'ç”Ÿæ´»ç…§',
                    'couple': 'æƒ…ä¾£ç…§',
                    'wedding': 'å©šçº±ç…§'
                };
                
                allTemplates.forEach(template => {
                    const categoryName = categoryMap[template.category];
                    if (categoryName && templatesData[categoryName]) {
                        templatesData[categoryName].push(template);
                    }
                });
                
                console.log(`âœ… åŠ è½½äº† ${allTemplates.length} ä¸ªæ¨¡æ¿`);
                console.log(`ğŸ“Š åˆ†ç±»ç»Ÿè®¡:`, {
                    'ç”Ÿæ´»ç…§': templatesData['ç”Ÿæ´»ç…§'].length,
                    'æƒ…ä¾£ç…§': templatesData['æƒ…ä¾£ç…§'].length,
                    'å©šçº±ç…§': templatesData['å©šçº±ç…§'].length
                });
                
                // æ˜¾ç¤ºé»˜è®¤åˆ†ç±»
                displayTemplates('ç”Ÿæ´»ç…§');
                
            } catch (error) {
                console.error('âŒ åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                const grid = document.getElementById('templateGrid');
                grid.innerHTML = '<p class="text-center" style="padding: 40px; color: #ff6b6b;">åŠ è½½æ¨¡æ¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
            }
        }

        function displayTemplates(category) {
            console.log(`ğŸ“š Displaying category: ${category}`);
            const grid = document.getElementById('templateGrid');
            const templates = templatesData[category] || [];

            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (templates.length === 0) {
                grid.innerHTML = '<p class="text-center" style="padding: 40px; opacity: 0.5;">æ­¤åˆ†ç±»ä¸‹æš‚æ— æ¨¡æ¿</p>';
                return;
            }
            
            grid.innerHTML = templates.map((template) => {
                const imgSrc = template.image_path || template.image || template.preview_url || '';
                const templateName = template.name || `${category} #${template.id}`;
                return `
                <div class="template-card" onclick="selectTemplate(this, '${imgSrc}', ${template.id})" data-template-id="${template.id}" data-template-url="${imgSrc}">
                    <img src="${imgSrc}" alt="${templateName}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 300%22%3E%3Crect fill=%22%23333%22 width=%22200%22 height=%22300%22/%3E%3C/svg%3E'">
                    <div class="template-info">
                        <div class="template-name">${templateName}</div>
                    </div>
                </div>
            `}).join('');

            // Reset selection when changing category
            selectedTemplateId = null;
            selectedTemplate = null;
            updateButtons();
        }

        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        function loadTemplates() {
            // Load templates from API
            loadTemplatesFromAPI();
        }
        
        // é€‰æ‹©æ¨¡æ¿
        function selectTemplate(cardElement, imageUrl, templateId) {
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
            if (cardElement) {
                cardElement.classList.add('selected');
            }
            
            // ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾å®Œæ•´çš„æ¨¡æ¿å¯¹è±¡
            const templateObj = allTemplates.find(t => t.id === templateId);
            
            if (templateObj) {
                // ä½¿ç”¨æ•°æ®åº“ä¸­çš„æ¨¡æ¿å¯¹è±¡
                selectedTemplateId = templateObj.id;
                selectedTemplate = {
                    id: templateObj.id,
                    name: templateObj.name,
                    idol_image_url: templateObj.image_path || imageUrl,
                    prompt: templateObj.prompt || "a photo of a person in the style of the reference image"
                };
                
                console.log('âœ… é€‰ä¸­æ¨¡æ¿:', selectedTemplate.name);
                console.log('  - ID:', selectedTemplate.id);
                console.log('  - URL:', selectedTemplate.idol_image_url);
            } else {
                // å…¼å®¹æ—§æ•°æ®
                selectedTemplateId = imageUrl;
                selectedTemplate = {
                    id: imageUrl,
                    name: cardElement.querySelector('.template-name').textContent,
                    idol_image_url: imageUrl,
                    prompt: "a photo of a person in the style of the reference image"
                };
            }
            
            updateButtons();
        }
        
        // æ¨¡æ¿æ¨¡å¼ï¼šä¸‹ä¸€æ­¥
        function templateNext() {
            document.getElementById('templateStep1').classList.add('hidden');
            document.getElementById('templateStep2').classList.remove('hidden');
        }
        
        // æ¨¡æ¿æ¨¡å¼ï¼šè¿”å›
        function templateBack() {
            document.getElementById('templateStep2').classList.add('hidden');
            document.getElementById('templateStep1').classList.remove('hidden');
        }
        
        // å¤„ç†æ¨¡æ¿ç”¨æˆ·å›¾ç‰‡ä¸Šä¼ 
        function handleTemplateUserImage(input) {
            if (input.files && input.files[0]) {
                templateUserImageFile = input.files[0];
                console.log('ğŸ“¸ ç”¨æˆ·ç…§ç‰‡å·²é€‰æ‹©:', templateUserImageFile.name);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('templateUserPreview');
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="é¢„è§ˆ">
                        <div class="file-name">âœ… ${templateUserImageFile.name}</div>
                    `;
                    preview.classList.remove('hidden');
                    input.parentElement.classList.add('has-file');
                };
                reader.readAsDataURL(templateUserImageFile);
                
                updateButtons();
            }
        }
        
        // æ¨¡æ¿æ¨¡å¼ï¼šç”Ÿæˆ
        async function generateWithTemplate() {
            if (!selectedTemplateId || !templateUserImageFile) {
                alert('è¯·é€‰æ‹©æ¨¡æ¿å¹¶ä¸Šä¼ ç…§ç‰‡');
                return;
            }
            
            console.log('ğŸ¨ å¼€å§‹ç”Ÿæˆï¼ˆæ¨¡æ¿æ¨¡å¼ï¼‰');
            console.log('æ¨¡æ¿ID:', selectedTemplateId);
            console.log('æ¨¡æ¿æ•°æ®:', selectedTemplate);
            console.log('ç”¨æˆ·ç…§ç‰‡:', templateUserImageFile.name);
            
            showGenerating();
            
            try {
                // æ­¥éª¤1ï¼šå‡†å¤‡æ•°æ®
                updateStep(1, 'processing');
                document.getElementById('overallStatus').textContent = 'æ­¥éª¤1/6: å‡†å¤‡æ•°æ®...';
                await sleep(500);
                
                // è·å–æ¨¡æ¿ä¿¡æ¯
                if (!selectedTemplate || !selectedTemplate.idol_image_url || !selectedTemplate.prompt) {
                    updateStep(1, 'failed', 'æ¨¡æ¿æ•°æ®ä¸å®Œæ•´');
                    throw new Error('æ¨¡æ¿ç¼ºå°‘å¿…è¦æ•°æ®ï¼ˆpromptæˆ–å¶åƒç…§ç‰‡ï¼‰');
                }
                
                console.log('âœ“ æ¨¡æ¿Prompt:', selectedTemplate.prompt);
                console.log('âœ“ æ¨¡æ¿å¶åƒç…§ç‰‡:', selectedTemplate.idol_image_url);
                updateStep(1, 'completed');
                
                // æ­¥éª¤2ï¼šç»„åˆæ•°æ®
                updateStep(2, 'processing');
                document.getElementById('overallStatus').textContent = 'æ­¥éª¤2/6: ç»„åˆæ•°æ®...';
                await sleep(500);
                
                const formData = new FormData();
                formData.append('image', templateUserImageFile);
                formData.append('templateId', selectedTemplateId);
                
                console.log('âœ“ æ•°æ®ç»„åˆå®Œæˆ');
                console.log('  - ç”¨æˆ·ç…§ç‰‡:', templateUserImageFile.name);
                console.log('  - æ¨¡æ¿ID:', selectedTemplateId);
                updateStep(2, 'completed');
                
                // æ­¥éª¤3ï¼šå‘é€åˆ°è€å¼ API
                updateStep(3, 'processing');
                document.getElementById('overallStatus').textContent = 'æ­¥éª¤3/6: å‘é€åˆ°è€å¼ API...';
                
                console.log('ğŸ“¤ å‘é€è¯·æ±‚åˆ°åç«¯API...');
                console.log('  - Token:', currentToken ? 'æœ‰' : 'æ— ');
                
                const response = await fetch('/api/generate/preview', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });

                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status, response.statusText);
                
                if (!response.ok) {
                    updateStep(3, 'failed', `HTTP ${response.status}`);
                const data = await response.json();
                    throw new Error(data.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
                
                updateStep(3, 'completed');
                
                // æ­¥éª¤4-5ï¼šAIå¤„ç†ï¼ˆåç«¯å¤„ç†ï¼‰
                updateStep(4, 'processing');
                updateStep(5, 'processing');
                document.getElementById('overallStatus').textContent = 'æ­¥éª¤4-5/6: AIæ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
                
                const data = await response.json();
                console.log('ğŸ“¦ å“åº”æ•°æ®:', data);
                
                if (!data.success) {
                    updateStep(4, 'failed', data.message);
                    throw new Error(data.message || 'ç”Ÿæˆå¤±è´¥');
                }
                
                updateStep(4, 'completed');
                updateStep(5, 'completed');
                
                // æ­¥éª¤6ï¼šä¿å­˜å›¾ç‰‡
                updateStep(6, 'processing');
                document.getElementById('overallStatus').textContent = 'æ­¥éª¤6/6: ä¿å­˜å›¾ç‰‡...';
                await sleep(500);
                
                if (!data.imageUrl) {
                    updateStep(6, 'failed', 'æœªè¿”å›å›¾ç‰‡URL');
                    throw new Error('æœåŠ¡å™¨æœªè¿”å›å›¾ç‰‡URL');
                }
                
                updateStep(6, 'completed');
                document.getElementById('overallStatus').textContent = 'âœ… å…¨éƒ¨å®Œæˆï¼';
                
                console.log('âœ… ç”ŸæˆæˆåŠŸ:', data);
                
                // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°æ‰€æœ‰æ­¥éª¤å®Œæˆ
                await sleep(1000);
                showResult(data);
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆå¤±è´¥è¯¦æƒ…:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                document.getElementById('overallStatus').textContent = 'âŒ ç”Ÿæˆå¤±è´¥';
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
                showError('ç”Ÿæˆå¤±è´¥ï¼š' + error.message + '\n\nè¯·æŸ¥çœ‹ä¸Šæ–¹æ­¥éª¤ï¼Œäº†è§£åœ¨å“ªä¸€æ­¥å‡ºé”™\n\nè¯¦ç»†ä¿¡æ¯è¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°');
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå»¶è¿Ÿ
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // ========== è‡ªç”±æ¨¡å¼é€»è¾‘ ==========
        
        // å¤„ç†è‡ªç”±æ¨¡å¼ç”¨æˆ·å›¾ç‰‡
        function handleFreestyleUserImage(input) {
            if (input.files && input.files[0]) {
                freestyleUserImageFile = input.files[0];
                showImagePreview(input.files[0], 'freestyleUserPreview', input.parentElement);
                updateButtons();
            }
        }
        
        // å¤„ç†è‡ªç”±æ¨¡å¼å¶åƒå›¾ç‰‡
        function handleFreestyleIdolImage(input) {
            if (input.files && input.files[0]) {
                freestyleIdolImageFile = input.files[0];
                showImagePreview(input.files[0], 'freestyleIdolPreview', input.parentElement);
                updateButtons();
            }
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImagePreview(file, previewId, uploadBox) {
                const reader = new FileReader();
                reader.onload = (e) => {
                const preview = document.getElementById(previewId);
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="é¢„è§ˆ">
                    <div class="file-name">âœ… ${file.name}</div>
                `;
                preview.classList.remove('hidden');
                uploadBox.classList.add('has-file');
                };
                reader.readAsDataURL(file);
            }
        
        // è‡ªç”±æ¨¡å¼ï¼šç”Ÿæˆ
        async function generateFreestyle() {
            const prompt = document.getElementById('freestylePrompt').value.trim();
            
            if (!freestyleUserImageFile || !freestyleIdolImageFile || !prompt) {
                alert('è¯·ä¸Šä¼ ç…§ç‰‡ã€å‚è€ƒå›¾å¹¶å¡«å†™æè¿°');
                return;
            }
            
            console.log('âœ¨ å¼€å§‹ç”Ÿæˆï¼ˆè‡ªç”±æ¨¡å¼ï¼‰');
            console.log('ç”¨æˆ·ç…§ç‰‡:', freestyleUserImageFile.name);
            console.log('å‚è€ƒå›¾:', freestyleIdolImageFile.name);
            console.log('Prompt:', prompt);
            
            showGenerating();
            
            try {
                const formData = new FormData();
                formData.append('image', freestyleUserImageFile);
                formData.append('idolImage', freestyleIdolImageFile);
                formData.append('prompt', prompt);
                
                console.log('ğŸ“¤ å‘é€è¯·æ±‚åˆ°åç«¯...');
                console.log('  - ç…§ç‰‡:', freestyleUserImageFile.name);
                console.log('  - å‚è€ƒå›¾:', freestyleIdolImageFile.name);
                console.log('  - Prompt:', prompt.substring(0, 50) + '...');
                console.log('  - Token:', currentToken ? 'æœ‰' : 'æ— ');
                
                const response = await fetch('/api/generate/preview', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });
                
                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status, response.statusText);

                const data = await response.json();
                console.log('ğŸ“¦ å“åº”æ•°æ®:', data);
                
                if (!response.ok) {
                    let errorMsg = data.message || 'ç”Ÿæˆå¤±è´¥';
                    if (data.details) {
                        errorMsg += '\nè¯¦æƒ…: ' + JSON.stringify(data.details);
                    }
                    throw new Error(errorMsg);
                }
                
                console.log('âœ… ç”ŸæˆæˆåŠŸ:', data);
                showResult(data);
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆå¤±è´¥è¯¦æƒ…:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showError(error.message + '\n\nè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°(F12)è·å–è¯¦ç»†ä¿¡æ¯');
            }
        }
        
        // ========== ç»“æœå±•ç¤º ==========
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNumber, status, message) {
            const step = document.getElementById(`step${stepNumber}`);
            const statusElement = step.querySelector('.step-status');
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            step.classList.remove('processing', 'completed', 'failed');
            
            // æ·»åŠ æ–°çŠ¶æ€
            step.classList.add(status);
            
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            if (message) {
                statusElement.textContent = message;
            }
            
            // å¦‚æœæ˜¯processingï¼Œæ·»åŠ åŠ¨ç”»
            if (status === 'processing') {
                statusElement.textContent = 'æ­£åœ¨å¤„ç†...';
            } else if (status === 'completed') {
                statusElement.textContent = 'âœ“ å®Œæˆ';
            } else if (status === 'failed') {
                statusElement.textContent = 'âœ— å¤±è´¥: ' + message;
            }
        }
        
        // é‡ç½®æ‰€æœ‰æ­¥éª¤
        function resetAllSteps() {
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('processing', 'completed', 'failed');
                const statusElement = step.querySelector('.step-status');
                statusElement.textContent = 'ç­‰å¾…ä¸­...';
            }
        }
        
        // æ˜¾ç¤ºç”Ÿæˆä¸­
        let progressInterval = null;
        
        function showGenerating() {
            document.getElementById('templateMode').classList.remove('active');
            document.getElementById('freestyleMode').classList.remove('active');
            document.getElementById('resultArea').classList.add('active');
            document.getElementById('generating').classList.remove('hidden');
            document.getElementById('resultSuccess').classList.add('hidden');
            document.getElementById('resultError').classList.add('hidden');
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            resetAllSteps();
            
            // å¯åŠ¨è¿›åº¦æ¡
            startProgressBar();
        }
        
        function startProgressBar() {
            const progressBar = document.getElementById('aiProgressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressTime = document.getElementById('progressTime');
            const statusText = document.getElementById('aiStatusText');
            
            let progress = 0;
            let elapsedTime = 0;
            
            // æ¸…é™¤ä¹‹å‰çš„interval
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            // é‡ç½®è¿›åº¦
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡
            progressInterval = setInterval(() => {
                elapsedTime++;
                
                // æ¨¡æ‹Ÿè¿›åº¦å¢é•¿ï¼ˆå‰30ç§’å¿«ï¼Œåé¢æ…¢ï¼‰
                if (progress < 30) {
                    progress += 1.5;
                } else if (progress < 60) {
                    progress += 0.8;
                } else if (progress < 85) {
                    progress += 0.3;
                } else if (progress < 95) {
                    progress += 0.1;
                }
                
                progress = Math.min(progress, 95); // æœ€å¤šåˆ°95%
                progressBar.style.width = progress + '%';
                progressPercent.textContent = Math.round(progress) + '%';
                
                // æ›´æ–°å‰©ä½™æ—¶é—´
                const remaining = Math.max(0, 50 - elapsedTime);
                progressTime.textContent = `å‰©ä½™çº¦ ${remaining} ç§’`;
                
                // æ›´æ–°æç¤ºæ–‡å­—
                if (progress < 20) {
                    statusText.textContent = 'AIæ­£åœ¨ç†è§£æ‚¨çš„éœ€æ±‚...';
                } else if (progress < 50) {
                    statusText.textContent = 'AIæ­£åœ¨åˆ›ä½œä¸­...';
                } else if (progress < 80) {
                    statusText.textContent = 'AIæ­£åœ¨ç²¾å¿ƒé›•ç¢ç»†èŠ‚...';
                } else {
                    statusText.textContent = 'AIæ­£åœ¨å®Œæˆæœ€åçš„æ¶¦è‰²...';
                }
            }, 1000);
        }
        
        function completeProgressBar() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            const progressBar = document.getElementById('aiProgressBar');
            const progressPercent = document.getElementById('progressPercent');
            const statusText = document.getElementById('aiStatusText');
            
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            statusText.textContent = 'åˆ›ä½œå®Œæˆï¼';
        }
        
        // æ˜¾ç¤ºç”Ÿæˆç»“æœ
        async function showResult(data) {
            console.log("Showing result with data:", data);
            completeProgressBar(); // å®Œæˆè¿›åº¦æ¡
            const imageUrl = data.imageUrl || data.previewImageUrl;
            if (!imageUrl) {
                console.error("showResult called, but no image URL found!", data);
                throw new Error('æœåŠ¡å™¨æœªè¿”å›å›¾ç‰‡URL');
            }

            currentGenerationId = data.generationId;

            // éšè—è¿›åº¦ç•Œé¢
            document.getElementById('generating').classList.add('hidden');
            // æ˜¾ç¤ºæˆåŠŸç»“æœç•Œé¢
            document.getElementById('resultSuccess').classList.remove('hidden');

            const resultImage = document.getElementById('resultImage');
            resultImage.src = `${imageUrl}?t=${Date.now()}`;
            
            // æ˜¾ç¤ºä¿¡æ¯
            document.getElementById('processingTime').textContent = data.processingTime || '0';
            document.getElementById('remainingPreviews').textContent = data.remainingPreviews || '0';
            
            console.log('âœ… ç»“æœæ˜¾ç¤ºå®Œæˆï¼å›¾ç‰‡URL:', imageUrl);
        }

        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // å¿…å¡«é¡¹éªŒè¯
            if (!username || !password || !passwordConfirm) {
                alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼š\n- ç”¨æˆ·å\n- å¯†ç \n- ç¡®è®¤å¯†ç ');
                return;
            }
            
            // ç”¨æˆ·åéªŒè¯
            if (username.length < 2) {
                alert('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
                return;
            }
            
            // é‚®ç®±éªŒè¯ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®\n\nè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼Œä¾‹å¦‚ï¼š\nuser@example.com\næˆ–è€…ç•™ç©ºä¸å¡«å†™é‚®ç®±');
                    return;
                }
            }
            
            // å¯†ç éªŒè¯
            if (password.length < 6) {
                alert('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                return;
                }
            
            if (password !== passwordConfirm) {
                alert('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
                return;
            }

            try {
                // æ„å»ºæ³¨å†Œæ•°æ®ï¼ˆå¦‚æœé‚®ç®±ä¸ºç©ºå°±ä¸å‘é€ï¼‰
                const registerData = { username, password };
                if (email) {
                    registerData.email = email;
                }
                
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registerData)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'æ³¨å†Œå¤±è´¥');
                }
                
                console.log('âœ… æ³¨å†ŒæˆåŠŸ');
                localStorage.setItem('token', data.token);
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                
                closeAuthModal();
                checkLoginStatus();
                
            } catch (error) {
                alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            currentToken = null;
            currentUser = null;
            
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            
            backToModeSelection();
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            // æ¨¡æ¿æ¨¡å¼ï¼šä¸‹ä¸€æ­¥æŒ‰é’®
            const templateNextBtn = document.getElementById('templateNextBtn');
            if (templateNextBtn) {
                templateNextBtn.disabled = !selectedTemplateId;
            }
            
            // æ¨¡æ¿æ¨¡å¼ï¼šç”ŸæˆæŒ‰é’®
            const templateGenerateBtn = document.getElementById('templateGenerateBtn');
            if (templateGenerateBtn) {
                templateGenerateBtn.disabled = !templateUserImageFile;
            }
            
            // è‡ªç”±æ¨¡å¼ï¼šç”ŸæˆæŒ‰é’®
            const freestyleGenerateBtn = document.getElementById('freestyleGenerateBtn');
            if (freestyleGenerateBtn) {
                const prompt = document.getElementById('freestylePrompt').value.trim();
                freestyleGenerateBtn.disabled = !freestyleUserImageFile || !freestyleIdolImageFile || !prompt;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('generating').classList.add('hidden');
            document.getElementById('resultSuccess').classList.add('hidden');
            document.getElementById('resultError').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        // å¼€å§‹æ–°çš„åˆ›ä½œ
        function startNew() {
            backToModeSelection();
        }
        
        // ä¸‹è½½é«˜æ¸…ç‰ˆ
        async function downloadHighQuality() {
            if (!currentGenerationId) {
                alert('ç”ŸæˆIDä¸¢å¤±ï¼Œæ— æ³•ä¸‹è½½');
                return;
            }
            
            alert('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­...\nç”ŸæˆID: ' + currentGenerationId);
        }
        
        // ç™»å½•
        async function login() {
            const identifier = document.getElementById('loginIdentifier').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!identifier || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'ç™»å½•å¤±è´¥');
                }
                
                console.log('âœ… ç™»å½•æˆåŠŸ');
                localStorage.setItem('token', data.token);
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                
                closeAuthModal();
                checkLoginStatus();
                
            } catch (error) {
                alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('authTitle').textContent = 'ç™»å½•';
        }
        
        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }
        
        // åˆ‡æ¢åˆ°æ³¨å†Œ
        function switchToRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'æ³¨å†Œ';
        }
        
        // åˆ‡æ¢åˆ°ç™»å½•
        function switchToLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'ç™»å½•';
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            // æ¨¡æ¿æ¨¡å¼ï¼šä¸‹ä¸€æ­¥æŒ‰é’®
            const templateNextBtn = document.getElementById('templateNextBtn');
            if (templateNextBtn) {
                templateNextBtn.disabled = !selectedTemplateId;
            }
            
            // æ¨¡æ¿æ¨¡å¼ï¼šç”ŸæˆæŒ‰é’®
            const templateGenerateBtn = document.getElementById('templateGenerateBtn');
            if (templateGenerateBtn) {
                templateGenerateBtn.disabled = !templateUserImageFile;
            }
            
            // è‡ªç”±æ¨¡å¼ï¼šç”ŸæˆæŒ‰é’®
            const freestyleGenerateBtn = document.getElementById('freestyleGenerateBtn');
            if (freestyleGenerateBtn) {
                const prompt = document.getElementById('freestylePrompt').value.trim();
                freestyleGenerateBtn.disabled = !freestyleUserImageFile || !freestyleIdolImageFile || !prompt;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('generating').classList.add('hidden');
            document.getElementById('resultSuccess').classList.add('hidden');
            document.getElementById('resultError').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        // å¼€å§‹æ–°çš„åˆ›ä½œ
        function startNew() {
            backToModeSelection();
        }
        
        // ä¸‹è½½é«˜æ¸…ç‰ˆ
        async function downloadHighQuality() {
            if (!currentGenerationId) {
                alert('ç”ŸæˆIDä¸¢å¤±ï¼Œæ— æ³•ä¸‹è½½');
                return;
            }
            
            alert('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­...\nç”ŸæˆID: ' + currentGenerationId);
        }
        
        // ç™»å½•
        async function login() {
            const identifier = document.getElementById('loginIdentifier').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!identifier || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'ç™»å½•å¤±è´¥');
                }
                
                console.log('âœ… ç™»å½•æˆåŠŸ');
                localStorage.setItem('token', data.token);
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                
                closeAuthModal();
                checkLoginStatus();
                
            } catch (error) {
                alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('authTitle').textContent = 'ç™»å½•';
        }
        
        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }
        
        // åˆ‡æ¢åˆ°æ³¨å†Œ
        function switchToRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'æ³¨å†Œ';
        }
        
        // åˆ‡æ¢åˆ°ç™»å½•
        function switchToLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'ç™»å½•';
        }
    </script>
    <script src="/yuan/js/behavior-tracker.js"></script>
</body>
</html>

