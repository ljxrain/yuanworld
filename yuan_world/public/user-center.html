<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 源世界</title>
    <style>
        :root { --main-color: #90EE90; --dark-bg: #121212; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--dark-bg); color: #fff; line-height: 1.6; }
        
        /* 导航栏 */
        nav { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); padding: 15px 0; border-bottom: 1px solid rgba(144,238,144,0.2); }
        .nav-content { max-width: 1400px; margin: 0 auto; padding: 0 40px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; background: linear-gradient(135deg, #90EE90, #37B679); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .nav-links { display: flex; gap: 30px; align-items: center; }
        .nav-link { color: #fff; font-weight: 500; text-decoration: none; transition: color 0.3s; }
        .nav-link:hover { color: #90EE90; }
        
        .container { max-width: 1200px; margin: 100px auto 40px; padding: 0 20px; }
        
        /* 用户信息卡片 */
        .user-header { background: linear-gradient(135deg, #1a1a1a, #252525); border-radius: 20px; padding: 40px; margin-bottom: 30px; border: 2px solid #333; }
        .user-info { display: flex; align-items: center; gap: 30px; }
        .user-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #90EE90, #37B679); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; color: #111; }
        .user-details h2 { font-size: 2rem; margin-bottom: 10px; }
        .user-meta { display: flex; gap: 20px; margin-top: 15px; }
        .meta-item { background: rgba(144,238,144,0.1); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; }
        
        /* VIP徽章 */
        .vip-badge { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; padding: 5px 15px; border-radius: 15px; font-weight: 600; font-size: 0.85rem; }
        
        /* 余额卡片 */
        .balance-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .balance-card { background: linear-gradient(135deg, #1a1a1a, #252525); border-radius: 15px; padding: 30px; border: 2px solid #333; text-align: center; transition: transform 0.3s; }
        .balance-card:hover { transform: translateY(-5px); border-color: var(--main-color); }
        .balance-label { font-size: 0.9rem; opacity: 0.7; margin-bottom: 10px; }
        .balance-amount { font-size: 2.5rem; font-weight: 700; color: var(--main-color); }
        .balance-unit { font-size: 1rem; opacity: 0.8; }
        
        /* 按钮 */
        .btn { padding: 12px 30px; border: none; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn-primary { background: linear-gradient(135deg, #90EE90, #37B679); color: #111; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(144,238,144,0.4); }
        .btn-secondary { background: #333; color: #fff; }
        .btn-secondary:hover { background: #444; }
        
        /* 标签页 */
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #333; }
        .tab { padding: 15px 30px; cursor: pointer; border: none; background: none; color: #fff; opacity: 0.6; font-size: 1rem; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab:hover { opacity: 1; }
        .tab.active { opacity: 1; color: var(--main-color); border-bottom-color: var(--main-color); }
        
        /* 内容区域 */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* 作品列表 */
        .works-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .work-card { background: #1a1a1a; border-radius: 12px; overflow: hidden; border: 2px solid #333; transition: all 0.3s; cursor: pointer; }
        .work-card:hover { transform: scale(1.05); border-color: var(--main-color); }
        .work-image { width: 100%; aspect-ratio: 2/3; background: #222; object-fit: cover; }
        .work-info { padding: 15px; }
        .work-title { font-size: 0.9rem; margin-bottom: 5px; }
        .work-status { font-size: 0.8rem; opacity: 0.7; }
        .status-paid { color: var(--main-color); }
        .status-preview { color: #FFA500; }
        
        /* 订单列表 */
        .order-list { display: flex; flex-direction: column; gap: 15px; }
        .order-card { background: #1a1a1a; border-radius: 12px; padding: 20px; border: 2px solid #333; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .order-id { font-size: 0.9rem; opacity: 0.7; }
        .order-amount { font-size: 1.3rem; font-weight: 700; color: var(--main-color); }
        .order-details { display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem; }
        
        /* 空状态 */
        .empty-state { text-align: center; padding: 60px 20px; opacity: 0.6; }
        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav>
        <div class="nav-content">
            <a href="/yuan/index.html" class="logo">源世界</a>
            <div class="nav-links">
                <a href="/yuan/index.html" class="nav-link">首页</a>
                <a href="/yuan/gallery.html" class="nav-link">模板中心</a>
                <a href="/yuan/create.html" class="nav-link">立即创作</a>
                <a href="/yuan/user-center.html" class="nav-link" style="color: #90EE90;">个人中心</a>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 20px;">退出登录</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <!-- 用户信息头部 -->
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h2 id="username">加载中...</h2>
                    <div class="user-meta">
                        <span class="meta-item" id="userEmail">邮箱: 未设置</span>
                        <span class="meta-item">注册时间: <span id="registerDate">-</span></span>
                        <span class="vip-badge" id="vipBadge" style="display: none;">💎 VIP会员</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 余额卡片 -->
        <div class="balance-cards">
            <div class="balance-card">
                <div class="balance-label">账户余额</div>
                <div class="balance-amount" id="balance">0</div>
                <div class="balance-unit">元</div>
                <button class="btn btn-primary" style="margin-top: 15px;" onclick="showRechargeModal()">💰 充值</button>
            </div>
            
            <div class="balance-card">
                <div class="balance-label">剩余预览次数</div>
                <div class="balance-amount" id="previewCount">0</div>
                <div class="balance-unit">次</div>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="location.href='create.html'">🎨 去创作</button>
            </div>
            
            <div class="balance-card">
                <div class="balance-label">VIP状态</div>
                <div class="balance-amount" id="vipStatus" style="font-size: 1.5rem;">普通用户</div>
                <div class="balance-unit" id="vipExpiry">-</div>
                <button class="btn btn-primary" id="vipBtn" style="margin-top: 15px;" onclick="showVipModal()">💎 开通VIP</button>
            </div>
        </div>
        
        <!-- 标签页 -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('works')">我的作品</button>
            <button class="tab" onclick="switchTab('orders')">消费记录</button>
            <button class="tab" onclick="switchTab('settings')">账户设置</button>
        </div>
        
        <!-- 我的作品 -->
        <div id="works" class="tab-content active">
            <div class="works-grid" id="worksGrid">
                <div class="empty-state">
                    <div class="empty-state-icon">📸</div>
                    <p>还没有作品，快去创作吧！</p>
                </div>
            </div>
        </div>
        
        <!-- 消费记录 -->
        <div id="orders" class="tab-content">
            <div class="order-list" id="orderList">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <p>暂无消费记录</p>
                </div>
            </div>
        </div>
        
        <!-- 账户设置 -->
        <div id="settings" class="tab-content">
            <div style="background: #1a1a1a; border-radius: 12px; padding: 30px; border: 2px solid #333;">
                <h3 style="margin-bottom: 20px;">账户设置</h3>
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">用户名</label>
                        <input type="text" id="settingUsername" style="width: 100%; padding: 12px; background: #222; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;" readonly>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">邮箱</label>
                        <input type="email" id="settingEmail" style="width: 100%; padding: 12px; background: #222; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;">
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="saveSettings()">💾 保存设置</button>
                        <button class="btn btn-secondary" onclick="showChangePasswordModal()" style="margin-left: 10px;">🔒 修改密码</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 充值弹窗 -->
    <div id="rechargeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #1a1a1a; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; border: 2px solid var(--main-color);">
            <h2 style="margin-bottom: 30px; color: var(--main-color);">💰 账户充值</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                <button class="btn btn-secondary" onclick="selectAmount(10)" style="padding: 20px;">¥10</button>
                <button class="btn btn-secondary" onclick="selectAmount(50)" style="padding: 20px;">¥50</button>
                <button class="btn btn-secondary" onclick="selectAmount(100)" style="padding: 20px;">¥100</button>
                <button class="btn btn-secondary" onclick="selectAmount(200)" style="padding: 20px;">¥200</button>
                <button class="btn btn-secondary" onclick="selectAmount(500)" style="padding: 20px;">¥500</button>
                <button class="btn btn-secondary" onclick="showCustomAmount()" style="padding: 20px;">自定义</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">充值金额</label>
                <input type="number" id="rechargeAmount" placeholder="请输入充值金额" style="width: 100%; padding: 12px; background: #222; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeRechargeModal()" style="flex: 1;">取消</button>
                <button class="btn btn-primary" onclick="processRecharge()" style="flex: 1;">确认充值</button>
            </div>
        </div>
    </div>
    
    <!-- VIP购买弹窗 -->
    <div id="vipModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #1a1a1a; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; border: 2px solid #FFD700;">
            <h2 style="margin-bottom: 20px; background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">💎 开通VIP会员</h2>
            <p style="margin-bottom: 30px; opacity: 0.8;">享受更多特权和优惠</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="vip-plan" onclick="selectVipPlan(1, 30)" style="background: #222; padding: 25px; border-radius: 12px; border: 2px solid #333; cursor: pointer; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">📅</div>
                    <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 5px;">月卡</div>
                    <div style="color: var(--main-color); font-size: 1.5rem; font-weight: 700;">¥30</div>
                </div>
                <div class="vip-plan" onclick="selectVipPlan(3, 80)" style="background: #222; padding: 25px; border-radius: 12px; border: 2px solid #333; cursor: pointer; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">📆</div>
                    <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 5px;">季卡</div>
                    <div style="color: var(--main-color); font-size: 1.5rem; font-weight: 700;">¥80</div>
                    <div style="font-size: 0.8rem; color: #FFA500;">省¥10</div>
                </div>
                <div class="vip-plan" onclick="selectVipPlan(12, 288)" style="background: #222; padding: 25px; border-radius: 12px; border: 2px solid #FFD700; cursor: pointer; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">🎁</div>
                    <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 5px;">年卡</div>
                    <div style="color: var(--main-color); font-size: 1.5rem; font-weight: 700;">¥288</div>
                    <div style="font-size: 0.8rem; color: #FFD700;">省¥72</div>
                </div>
            </div>
            
            <div style="background: rgba(255,215,0,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">VIP特权</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 8px;">✅ 每日预览次数翻倍</li>
                    <li style="margin-bottom: 8px;">✅ 下载高清图片8折优惠</li>
                    <li style="margin-bottom: 8px;">✅ 优先使用新功能</li>
                    <li style="margin-bottom: 8px;">✅ 专属客服支持</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeVipModal()" style="flex: 1;">取消</button>
                <button class="btn btn-primary" onclick="processVipPurchase()" style="flex: 1;">立即开通</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let currentToken = null;
        let selectedVipMonths = 1;
        let selectedVipPrice = 30;
        
        // 页面加载
        document.addEventListener('DOMContentLoaded', async () => {
            currentToken = localStorage.getItem('token');
            if (!currentToken) {
                alert('请先登录');
                location.href = 'create.html';
                return;
            }
            
            await loadUserData();
            await loadWorks();
            await loadOrders();
        });
        
        // 加载用户数据
        async function loadUserData() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) throw new Error('获取用户信息失败');
                
                const data = await response.json();
                currentUser = data.user;
                
                // 更新页面信息
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('userAvatar').textContent = currentUser.username[0].toUpperCase();
                document.getElementById('userEmail').textContent = `邮箱: ${currentUser.email || '未设置'}`;
                document.getElementById('registerDate').textContent = new Date(currentUser.created_at).toLocaleDateString();
                
                // 余额和次数（模拟数据，实际需要后端支持）
                document.getElementById('balance').textContent = currentUser.balance || 0;
                document.getElementById('previewCount').textContent = currentUser.free_previews || 0;
                
                // VIP状态
                if (currentUser.is_vip) {
                    document.getElementById('vipStatus').textContent = 'VIP会员';
                    document.getElementById('vipExpiry').textContent = `到期: ${currentUser.vip_expiry || '-'}`;
                    document.getElementById('vipBadge').style.display = 'inline-block';
                    document.getElementById('vipBtn').textContent = '💎 续费VIP';
                }
                
                // 设置页面
                document.getElementById('settingUsername').value = currentUser.username;
                document.getElementById('settingEmail').value = currentUser.email || '';
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                alert('获取用户信息失败，请重新登录');
            }
        }
        
        // 加载作品列表
        async function loadWorks() {
            try {
                const response = await fetch('/api/user/generations', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) throw new Error('获取作品列表失败');
                
                const data = await response.json();
                const works = data.generations || [];

                // 只显示有预览图的记录（不显示原图）
                const validWorks = works.filter(work => {
                    return work.preview_image_url && work.preview_image_url.trim() !== '';
                });

                const grid = document.getElementById('worksGrid');
                if (validWorks.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📸</div><p>还没有作品，快去创作吧！</p></div>';
                    return;
                }

                grid.innerHTML = validWorks.map(work => {
                    const shortId = work.id.substring(0, 8);

                    return `
                        <div class="work-card" onclick="viewWork('${work.preview_image_url}')">
                            <img src="${work.preview_image_url}" alt="作品" class="work-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 300%22%3E%3Crect fill=%22%23333%22 width=%22200%22 height=%22300%22/%3E%3C/svg%3E'">
                            <div class="work-info">
                                <div class="work-title">作品 #${shortId}</div>
                                <div class="work-status ${work.is_paid ? 'status-paid' : 'status-preview'}">
                                    ${work.is_paid ? '✅ 已购买' : '⚠️ 预览版'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('加载作品失败:', error);
            }
        }
        
        // 加载订单记录
        async function loadOrders() {
            // 模拟订单数据（实际需要后端API）
            const orders = [];
            
            const list = document.getElementById('orderList');
            if (orders.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><p>暂无消费记录</p></div>';
                return;
            }
            
            list.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">订单号: ${order.id}</div>
                            <div style="font-size: 0.85rem; opacity: 0.6; margin-top: 5px;">${order.date}</div>
                        </div>
                        <div class="order-amount">¥${order.amount}</div>
                    </div>
                    <div class="order-details">
                        <div>类型: ${order.type}</div>
                        <div>状态: <span style="color: var(--main-color);">${order.status}</span></div>
                    </div>
                </div>
            `).join('');
        }
        
        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // 充值相关
        function showRechargeModal() {
            document.getElementById('rechargeModal').style.display = 'flex';
        }
        
        function closeRechargeModal() {
            document.getElementById('rechargeModal').style.display = 'none';
        }
        
        function selectAmount(amount) {
            document.getElementById('rechargeAmount').value = amount;
        }
        
        function showCustomAmount() {
            document.getElementById('rechargeAmount').focus();
        }
        
        async function processRecharge() {
            const amount = document.getElementById('rechargeAmount').value;
            if (!amount || amount <= 0) {
                alert('请输入正确的充值金额');
                return;
            }
            
            alert(`充值功能开发中\n\n充值金额: ¥${amount}\n\n支付通道接入后即可使用`);
            closeRechargeModal();
        }
        
        // VIP相关
        function showVipModal() {
            document.getElementById('vipModal').style.display = 'flex';
        }
        
        function closeVipModal() {
            document.getElementById('vipModal').style.display = 'none';
        }
        
        function selectVipPlan(months, price) {
            selectedVipMonths = months;
            selectedVipPrice = price;
            
            // 更新选中状态
            document.querySelectorAll('.vip-plan').forEach(plan => {
                plan.style.borderColor = '#333';
            });
            event.currentTarget.style.borderColor = 'var(--main-color)';
        }
        
        async function processVipPurchase() {
            alert(`VIP购买功能开发中\n\n套餐: ${selectedVipMonths}个月\n价格: ¥${selectedVipPrice}\n\n支付通道接入后即可使用`);
            closeVipModal();
        }
        
        // 查看作品
        function viewWork(url) {
            window.open(url, '_blank');
        }
        
        // 保存设置
        async function saveSettings() {
            const email = document.getElementById('settingEmail').value;
            alert('保存设置功能开发中');
        }
        
        // 修改密码
        function showChangePasswordModal() {
            alert('修改密码功能开发中');
        }
        
        // 退出登录
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            location.href = 'index.html';
        }
    </script>
</body>
</html>










