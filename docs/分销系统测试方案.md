# 博世界分销系统测试方案

## 📋 测试目标
验证三级分销系统的完整功能：
- 用户注册并绑定邀请关系
- 支付成功后的佣金分配
- 佣金账户数据正确性
- 提现功能

---

## ⚠️ 当前系统存在的问题

### 问题1: 注册页面不存在
- **现象**: 后端生成的邀请链接为 `http://49.232.220.223/yuan/register.html?code=XXX`
- **实际**: register.html 页面不存在，注册功能在 create.html 的模态框中
- **影响**: 用户无法通过邀请链接注册

### 问题2: 注册时未绑定邀请码
- **现象**: 注册时没有读取URL参数中的邀请码
- **实际**: 需要注册后手动调用 `/api/distribution/bind-inviter` API
- **影响**: 邀请关系无法自动建立

### 问题3: 支付回调未触发佣金分配
- **现象**: 需要检查支付成功后是否调用佣金分配函数
- **影响**: 可能无法产生佣金记录

---

## 🔧 需要修复的内容

### 1. 创建独立注册页面或修改邀请链接
**方案A**: 创建 register.html 独立注册页面
**方案B**: 修改邀请链接指向 create.html?code=XXX 并在页面加载时读取邀请码

### 2. 注册时自动绑定邀请码
- 在注册API中接收 `inviter_code` 参数
- 注册成功后自动建立邀请关系
- 或者在前端注册成功后立即调用绑定API

### 3. 支付成功后调用佣金分配
- 在支付回调中调用 `calculateAndDistributeCommission` 函数
- 记录佣金分配日志

---

## 📝 完整测试流程（修复后）

### 准备阶段

#### 测试账号准备
需要3个不同的账号来测试三级分销：

| 角色 | 用户名 | 邮箱/手机 | 说明 |
|------|--------|-----------|------|
| **一级推广员** | user_L1 | 13800000001 | 顶级推广员，获取邀请码 |
| **二级推广员** | user_L2 | 13800000002 | 通过L1邀请码注册 |
| **三级用户/买家** | user_L3 | 13800000003 | 通过L2邀请码注册并支付 |

---

### 测试步骤

#### 第一步：一级推广员注册
1. 访问 `http://49.232.220.223/yuan/create.html`
2. 点击"登录/注册"按钮
3. 切换到"注册"标签
4. 填写信息：
   - 用户名: `user_L1`
   - 邮箱: `13800000001@test.com`（可选）
   - 密码: `123456`
   - 确认密码: `123456`
5. 点击"注册"按钮
6. 注册成功后，访问 `http://49.232.220.223/yuan/distribution.html`
7. 获取邀请码（例如：`ABC12345`）和邀请链接

**预期结果**:
- 注册成功并自动登录
- 分销中心显示邀请码
- 生成邀请链接

---

#### 第二步：二级推广员通过邀请链接注册
1. **换另一个浏览器或无痕模式**（模拟新用户）
2. 访问一级推广员的邀请链接（例如：`http://49.232.220.223/yuan/create.html?code=ABC12345`）
3. 点击"登录/注册"按钮
4. 切换到"注册"标签
5. 填写信息：
   - 用户名: `user_L2`
   - 邮箱: `13800000002@test.com`（可选）
   - 密码: `123456`
   - 确认密码: `123456`
6. 点击"注册"按钮
7. 注册成功后，访问分销中心获取自己的邀请码（例如：`DEF67890`）

**预期结果**:
- 注册成功
- 自动绑定到 user_L1 作为上级
- user_L1 的分销中心显示 1 个一级下线
- user_L2 可以获取自己的邀请码

---

#### 第三步：三级用户/买家通过二级邀请码注册
1. **再换一个浏览器或无痕模式**
2. 访问二级推广员的邀请链接（例如：`http://49.232.220.223/yuan/create.html?code=DEF67890`）
3. 注册账号：
   - 用户名: `user_L3`
   - 邮箱: `13800000003@test.com`（可选）
   - 密码: `123456`
   - 确认密码: `123456`
4. 注册成功

**预期结果**:
- 注册成功
- 自动绑定到 user_L2 作为上级
- user_L2 的分销中心显示 1 个一级下线
- user_L1 的分销中心显示 1 个二级下线

---

#### 第四步：三级用户支付（产生佣金）
1. 使用 user_L3 账号登录
2. 访问 `http://49.232.220.223/yuan/payment.html`
3. 选择充值套餐（例如：充值 ¥100）
4. 使用七相支付完成支付
5. 支付成功后等待回调

**预期结果**:
- 支付成功
- user_L3 余额增加 ¥100
- **一级推广员 user_L2** 获得佣金（例如：¥100 × 30% = ¥30）
- **二级推广员 user_L1** 获得佣金（例如：¥100 × 20% = ¥20）

---

### 数据库验证

#### 1. 查看邀请关系链
```sql
-- 查看所有邀请关系
SELECT
    u1.username AS 用户,
    u2.username AS 邀请人,
    ui.level AS 级别,
    ui.created_at AS 绑定时间
FROM user_invitations ui
LEFT JOIN users u1 ON ui.user_id = u1.id
LEFT JOIN users u2 ON ui.inviter_id = u2.id
ORDER BY ui.created_at DESC;
```

**预期结果**:
```
用户     | 邀请人  | 级别 | 绑定时间
---------|---------|------|--------------------
user_L3  | user_L2 | 1    | 2026-01-02 XX:XX:XX
user_L2  | user_L1 | 1    | 2026-01-02 XX:XX:XX
```

---

#### 2. 查看用户的邀请码
```sql
-- 查看所有用户的邀请码
SELECT
    username AS 用户名,
    invitation_code AS 我的邀请码,
    inviter_code AS 上级邀请码
FROM users
WHERE username IN ('user_L1', 'user_L2', 'user_L3')
ORDER BY created_at;
```

**预期结果**:
```
用户名   | 我的邀请码 | 上级邀请码
---------|-----------|------------
user_L1  | ABC12345  | NULL
user_L2  | DEF67890  | ABC12345
user_L3  | GHI11111  | DEF67890
```

---

#### 3. 查看分销统计数据
```sql
-- 查看所有用户的分销统计
SELECT
    u.username AS 用户名,
    uca.total_invited AS 总邀请人数,
    uca.level1_invited AS 一级下线,
    uca.level2_invited AS 二级下线,
    uca.level3_invited AS 三级下线,
    uca.total_commission AS 总佣金,
    uca.available_commission AS 可用佣金,
    uca.withdrawn_commission AS 已提现
FROM user_commission_accounts uca
LEFT JOIN users u ON uca.user_id = u.id
WHERE u.username IN ('user_L1', 'user_L2', 'user_L3')
ORDER BY u.created_at;
```

**预期结果**（user_L3 支付 ¥100 后）:
```
用户名   | 总邀请 | 一级 | 二级 | 三级 | 总佣金 | 可用佣金 | 已提现
---------|--------|------|------|------|--------|----------|--------
user_L1  | 2      | 1    | 1    | 0    | ¥20    | ¥20      | ¥0
user_L2  | 1      | 1    | 0    | 0    | ¥30    | ¥30      | ¥0
user_L3  | 0      | 0    | 0    | 0    | ¥0     | ¥0       | ¥0
```

---

#### 4. 查看佣金记录明细
```sql
-- 查看所有佣金记录
SELECT
    dc.out_trade_no AS 订单号,
    buyer.username AS 买家,
    distributor.username AS 分销商,
    dc.level AS 分销级别,
    dc.order_amount AS 订单金额,
    dc.commission_rate AS 佣金比例,
    dc.commission_amount AS 佣金金额,
    dc.status AS 状态,
    dc.created_at AS 创建时间
FROM distribution_commissions dc
LEFT JOIN users buyer ON dc.buyer_id = buyer.id
LEFT JOIN users distributor ON dc.distributor_id = distributor.id
ORDER BY dc.created_at DESC
LIMIT 20;
```

**预期结果**（user_L3 支付 ¥100 后）:
```
订单号      | 买家    | 分销商  | 级别 | 订单金额 | 佣金比例 | 佣金金额 | 状态      | 创建时间
------------|---------|---------|------|----------|----------|----------|-----------|--------------------
WD17xxxxx   | user_L3 | user_L2 | 1    | ¥100     | 30%      | ¥30      | confirmed | 2026-01-02 XX:XX:XX
WD17xxxxx   | user_L3 | user_L1 | 2    | ¥100     | 20%      | ¥20      | confirmed | 2026-01-02 XX:XX:XX
```

---

#### 5. 查看支付订单
```sql
-- 查看所有支付订单
SELECT
    po.out_trade_no AS 订单号,
    u.username AS 用户,
    po.product_name AS 产品名称,
    po.total_amount AS 金额,
    po.status AS 状态,
    po.created_at AS 创建时间,
    po.paid_at AS 支付时间
FROM payment_orders po
LEFT JOIN users u ON po.user_id = u.id
WHERE u.username IN ('user_L1', 'user_L2', 'user_L3')
ORDER BY po.created_at DESC;
```

**预期结果**:
```
订单号      | 用户    | 产品名称      | 金额  | 状态 | 创建时间            | 支付时间
------------|---------|---------------|-------|------|---------------------|--------------------
WD17xxxxx   | user_L3 | 余额充值-¥100 | ¥100  | paid | 2026-01-02 XX:XX:XX | 2026-01-02 XX:XX:XX
```

---

### 前端验证

#### 1. user_L1（二级推广员）查看分销中心
访问：`http://49.232.220.223/yuan/distribution.html`

**预期显示**:
- 总佣金：¥20
- 可用余额：¥20
- 总邀请人数：2
- 一级下线：1人
- 二级下线：1人
- 三级下线：0人
- 佣金记录：1条（来自 user_L3 的订单，¥20 佣金）

---

#### 2. user_L2（一级推广员）查看分销中心
访问：`http://49.232.220.223/yuan/distribution.html`

**预期显示**:
- 总佣金：¥30
- 可用余额：¥30
- 总邀请人数：1
- 一级下线：1人
- 二级下线：0人
- 三级下线：0人
- 佣金记录：1条（来自 user_L3 的订单，¥30 佣金）

---

#### 3. user_L3（买家）查看用户中心
访问：`http://49.232.220.223/yuan/user-center.html`

**预期显示**:
- 账户余额：¥100
- 消费记录：1条充值记录（¥100）

---

## 🔍 问题排查清单

### 如果邀请关系未建立
1. 检查 `users` 表的 `inviter_code` 字段是否已填充
2. 检查 `user_invitations` 表是否有记录
3. 检查注册时是否读取了URL参数中的邀请码
4. 检查 `/api/distribution/bind-inviter` API 是否被调用

### 如果佣金未产生
1. 检查 `distribution_commissions` 表是否有记录
2. 检查支付回调是否成功执行
3. 检查是否调用了 `calculateAndDistributeCommission` 函数
4. 检查 `distribution_config` 表的佣金比例配置
5. 查看服务器日志：`ssh yuan "pm2 logs yuan-world-app --lines 100"`

### 如果佣金金额不正确
1. 检查 `distribution_config` 表的配置：
```sql
SELECT * FROM distribution_config;
```
2. 检查佣金计算逻辑是否正确

---

## 📊 佣金比例配置查询

```sql
-- 查看当前佣金配置
SELECT
    level AS 级别,
    commission_rate AS 佣金比例,
    is_active AS 是否启用
FROM distribution_config
ORDER BY level;
```

**默认配置应该是**:
```
级别 | 佣金比例 | 是否启用
-----|----------|----------
1    | 30.00    | true
2    | 20.00    | true
3    | 10.00    | true
```

如果配置不正确，可以更新：
```sql
UPDATE distribution_config SET commission_rate = 30.00 WHERE level = 1;
UPDATE distribution_config SET commission_rate = 20.00 WHERE level = 2;
UPDATE distribution_config SET commission_rate = 10.00 WHERE level = 3;
```

---

## ✅ 测试通过标准

1. ✅ 三个用户成功注册
2. ✅ 邀请关系链正确建立（L3 → L2 → L1）
3. ✅ user_L3 支付 ¥100 成功
4. ✅ user_L2 获得 ¥30 佣金（一级 30%）
5. ✅ user_L1 获得 ¥20 佣金（二级 20%）
6. ✅ 数据库记录完整准确
7. ✅ 前端页面显示正确

---

## 🎯 下一步测试

1. **提现功能测试**: user_L1 或 user_L2 申请提现
2. **三级分销测试**: 让 user_L3 邀请新用户并支付
3. **VIP购买佣金测试**: 购买VIP是否也产生佣金
4. **预览次数购买测试**: 购买预览次数是否产生佣金

---

## 📌 注意事项

1. **使用不同浏览器或无痕模式**模拟不同用户，避免Cookie冲突
2. **记录所有邀请码**，方便后续验证
3. **保存订单号**，用于数据库查询验证
4. **支付测试**使用小金额（¥1 或 ¥10）避免浪费
5. **实时查看服务器日志**了解系统运行状态
