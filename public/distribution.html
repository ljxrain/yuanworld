<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é”€ä¸­å¿ƒ - åšä¸–ç•Œ</title>
    <style>
        :root {
            --main-color: #90EE90;
            --dark-bg: #121212;
            --card-bg: #1a1a1a;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark-bg);
            color: #fff;
            padding-top: 70px;
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            z-index: 1000;
            padding: 15px 0;
            border-bottom: 1px solid rgba(144,238,144,0.2);
        }
        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #90EE90, #37B679);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #333;
        }
        .stat-card h3 {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--main-color);
        }
        .section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--main-color);
        }
        .invite-code {
            background: #000;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .invite-code-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--main-color);
            letter-spacing: 5px;
            margin: 10px 0;
        }
        .invite-url {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        .btn {
            background: linear-gradient(135deg, #90EE90, #37B679);
            color: #111;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        .commission-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .commission-item {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .level-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .level-1 { background: #FFD700; color: #000; }
        .level-2 { background: #C0C0C0; color: #000; }
        .level-3 { background: #CD7F32; color: #fff; }
        .withdraw-form {
            display: grid;
            gap: 15px;
        }
        input, select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #000;
            color: #fff;
            font-size: 1rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--main-color);
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-content">
            <div class="logo">åšä¸–ç•Œ - åˆ†é”€ä¸­å¿ƒ</div>
            <a href="/yuan/user-center.html" style="color: #fff; text-decoration: none;">è¿”å›ç”¨æˆ·ä¸­å¿ƒ</a>
        </div>
    </header>

    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>ç´¯è®¡ä½£é‡‘</h3>
                <div class="stat-value">Â¥<span id="totalCommission">0</span></div>
            </div>
            <div class="stat-card">
                <h3>å¯æç°ä½£é‡‘</h3>
                <div class="stat-value">Â¥<span id="availableCommission">0</span></div>
            </div>
            <div class="stat-card">
                <h3>å·²æç°</h3>
                <div class="stat-value">Â¥<span id="withdrawnCommission">0</span></div>
            </div>
            <div class="stat-card">
                <h3>æ€»é‚€è¯·äººæ•°</h3>
                <div class="stat-value"><span id="totalInvited">0</span>äºº</div>
            </div>
        </div>

        <!-- é‚€è¯·åŒºåŸŸ -->
        <div class="section">
            <h2 class="section-title">æˆ‘çš„é‚€è¯·ç </h2>
            <div class="invite-code">
                <p>åˆ†äº«ç»™å¥½å‹ï¼ŒTAæ³¨å†Œåæ‚¨å°†è·å¾—ä½£é‡‘å¥–åŠ±</p>
                <div class="invite-code-display" id="invitationCode">åŠ è½½ä¸­...</div>
                <div class="invite-url" id="invitationUrl">-</div>

                <!-- åˆ†äº«æ–¹å¼è¯´æ˜ -->
                <div style="background: rgba(144,238,144,0.1); border-radius: 10px; padding: 15px; margin: 15px 0; border-left: 4px solid var(--main-color);">
                    <h4 style="margin: 0 0 10px 0; color: var(--main-color); font-size: 0.95rem;">ğŸ’¡ é€‰æ‹©åˆé€‚çš„åˆ†äº«æ–¹å¼</h4>
                    <div style="font-size: 0.85rem; color: #666; line-height: 1.6;">
                        <p style="margin: 5px 0;">ğŸ“‹ <strong>å£ä»¤åˆ†äº«</strong>ï¼šå¾®ä¿¡ç¾¤/æœ‹å‹åœˆï¼ˆ100%é˜²å°ï¼‰</p>
                        <p style="margin: 5px 0;">ğŸ”¥ <strong>æ´»ç æµ·æŠ¥</strong>ï¼šçº¿ä¸‹æ¨å¹¿/æœ‹å‹åœˆï¼ˆå¯åˆ‡æ¢åŸŸåï¼‰</p>
                        <p style="margin: 5px 0;">ğŸ–¼ï¸ <strong>æ™®é€šæµ·æŠ¥</strong>ï¼šå¾®ä¿¡åˆ†äº«ï¼ˆå£ä»¤äºŒç»´ç ï¼Œé˜²å°ï¼‰</p>
                        <p style="margin: 5px 0;">ğŸ”— <strong>ç›´æ¥é“¾æ¥</strong>ï¼šQQ/çŸ­ä¿¡/é‚®ä»¶ï¼ˆä¸€é”®æ‰“å¼€ï¼‰</p>
                    </div>
                </div>

                <!-- åˆ†äº«æŒ‰é’® -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button class="btn" onclick="openCommandShare()" style="background: #ff6b6b;">
                        ğŸ“‹ å£ä»¤åˆ†äº«<br><span style="font-size: 0.75rem; opacity: 0.8;">å¾®ä¿¡æ¨è</span>
                    </button>
                    <button class="btn btn-secondary" onclick="generateDynamicQRCode()">
                        ğŸ”¥ æ´»ç æµ·æŠ¥<br><span style="font-size: 0.75rem; opacity: 0.8;">å¯åˆ‡æ¢åŸŸå</span>
                    </button>
                    <button class="btn btn-secondary" onclick="generateQRCode()">
                        ğŸ–¼ï¸ æ™®é€šæµ·æŠ¥<br><span style="font-size: 0.75rem; opacity: 0.8;">å£ä»¤äºŒç»´ç </span>
                    </button>
                    <button class="btn btn-secondary" onclick="shareDirectLink()">
                        ğŸ”— ç›´æ¥é“¾æ¥<br><span style="font-size: 0.75rem; opacity: 0.8;">QQ/çŸ­ä¿¡é€‚ç”¨</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„å›¢é˜Ÿ -->
        <div class="section">
            <h2 class="section-title">æˆ‘çš„å›¢é˜Ÿ</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 20px;">
                <div>
                    <p style="color: #999;">ä¸€çº§æˆå‘˜</p>
                    <p style="font-size: 1.5rem; color: var(--main-color);"><span id="level1Count">0</span>äºº</p>
                </div>
                <div>
                    <p style="color: #999;">äºŒçº§æˆå‘˜</p>
                    <p style="font-size: 1.5rem; color: var(--main-color);"><span id="level2Count">0</span>äºº</p>
                </div>
                <div>
                    <p style="color: #999;">ä¸‰çº§æˆå‘˜</p>
                    <p style="font-size: 1.5rem; color: var(--main-color);"><span id="level3Count">0</span>äºº</p>
                </div>
            </div>
            <div id="teamList" class="loading">æ­£åœ¨åŠ è½½å›¢é˜Ÿæ•°æ®...</div>
        </div>

        <!-- ä½£é‡‘æ˜ç»† -->
        <div class="section">
            <h2 class="section-title">ä½£é‡‘æ˜ç»†</h2>
            <div id="commissionList" class="commission-list">
                <div class="loading">æ­£åœ¨åŠ è½½ä½£é‡‘è®°å½•...</div>
            </div>
        </div>

        <!-- æç°åŒºåŸŸ -->
        <div class="section">
            <h2 class="section-title">ç”³è¯·æç°</h2>
            <div class="withdraw-form">
                <input type="number" id="withdrawAmount" placeholder="æç°é‡‘é¢ï¼ˆæœ€ä½10å…ƒï¼‰" min="10" step="0.01">
                <select id="withdrawType">
                    <option value="alipay">æ”¯ä»˜å®</option>
                    <option value="wechat">å¾®ä¿¡</option>
                    <option value="bank">é“¶è¡Œå¡</option>
                </select>
                <input type="text" id="withdrawAccount" placeholder="æ”¶æ¬¾è´¦å·">
                <input type="text" id="accountName" placeholder="è´¦æˆ·å§“å">
                <button class="btn" onclick="submitWithdraw()">æäº¤æç°ç”³è¯·</button>
            </div>
        </div>
    </div>

    <script>
        let myData = null;

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/yuan/login.html';
                return;
            }

            await Promise.all([
                loadMyCode(),
                loadMyStats()
            ]);
        });

        // è·å–é‚€è¯·ç 
        async function loadMyCode() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/yuan/api/distribution/my-code', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('invitationCode').textContent = result.data.invitation_code;
                    document.getElementById('invitationUrl').textContent = result.data.invitation_url;
                }
            } catch (error) {
                console.error('è·å–é‚€è¯·ç å¤±è´¥:', error);
            }
        }

        // è·å–åˆ†é”€æ•°æ®
        async function loadMyStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/yuan/api/distribution/my-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    myData = result.data;
                    updateStats(myData.account);
                    updateCommissionList(myData.recent_commissions);
                }
            } catch (error) {
                console.error('è·å–åˆ†é”€æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(account) {
            document.getElementById('totalCommission').textContent = parseFloat(account.total_commission || 0).toFixed(2);
            document.getElementById('availableCommission').textContent = parseFloat(account.available_commission || 0).toFixed(2);
            document.getElementById('withdrawnCommission').textContent = parseFloat(account.withdrawn_commission || 0).toFixed(2);
            document.getElementById('totalInvited').textContent = account.total_invited || 0;
            document.getElementById('level1Count').textContent = account.level1_invited || 0;
            document.getElementById('level2Count').textContent = account.level2_invited || 0;
            document.getElementById('level3Count').textContent = account.level3_invited || 0;
        }

        // æ›´æ–°ä½£é‡‘åˆ—è¡¨
        function updateCommissionList(commissions) {
            const container = document.getElementById('commissionList');
            if (!commissions || commissions.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— ä½£é‡‘è®°å½•</div>';
                return;
            }

            container.innerHTML = commissions.map(c => `
                <div class="commission-item">
                    <div>
                        <span class="level-badge level-${c.level}">${c.level}çº§</span>
                        <span style="margin-left: 10px;">${c.product_name || 'è®¢å•'}</span>
                    </div>
                    <div>
                        <span style="color: var(--main-color); font-weight: bold;">+Â¥${parseFloat(c.commission_amount).toFixed(2)}</span>
                        <span style="color: #999; margin-left: 10px;">${new Date(c.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // å¤åˆ¶é‚€è¯·é“¾æ¥
        function copyInviteLink() {
            const url = document.getElementById('invitationUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('é‚€è¯·é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // æ‰“å¼€å£ä»¤åˆ†äº«é¡µé¢
        function openCommandShare() {
            const code = document.getElementById('invitationCode').textContent;
            const url = document.getElementById('invitationUrl').textContent;

            if (!code || code === 'åŠ è½½ä¸­...') {
                alert('è¯·ç¨ç­‰ï¼Œæ­£åœ¨åŠ è½½é‚€è¯·ç ...');
                return;
            }

            // æ‰“å¼€å£ä»¤åˆ†äº«é¡µé¢
            const commandUrl = `/yuan/invite-code-share.html?code=${code}&url=${encodeURIComponent(url)}`;
            window.open(commandUrl, '_blank', 'width=500,height=700');
        }

        // æ–¹æ¡ˆ4ï¼šç›´æ¥é“¾æ¥åˆ†äº«ï¼ˆé€‚åˆQQã€çŸ­ä¿¡ã€é‚®ä»¶ç­‰éå¾®ä¿¡åœºæ™¯ï¼‰
        function shareDirectLink() {
            const code = document.getElementById('invitationCode').textContent;
            const url = document.getElementById('invitationUrl').textContent;

            if (!code || code === 'åŠ è½½ä¸­...') {
                alert('è¯·ç¨ç­‰ï¼Œæ­£åœ¨åŠ è½½é‚€è¯·ç ...');
                return;
            }

            // æ‰“å¼€ç›´æ¥é“¾æ¥åˆ†äº«é¡µé¢
            const directLinkUrl = `/yuan/direct-link-share.html?code=${code}&url=${encodeURIComponent(url)}`;
            window.open(directLinkUrl, '_blank', 'width=500,height=700');
        }

        // ç”ŸæˆäºŒç»´ç æµ·æŠ¥
        function generateQRCode() {
            const code = document.getElementById('invitationCode').textContent;
            const url = document.getElementById('invitationUrl').textContent;

            if (!code || code === 'åŠ è½½ä¸­...') {
                alert('è¯·ç¨ç­‰ï¼Œæ­£åœ¨åŠ è½½é‚€è¯·ç ...');
                return;
            }

            // æ‰“å¼€äºŒç»´ç æµ·æŠ¥é¡µé¢
            const posterUrl = `/yuan/qrcode-modal.html?code=${code}&url=${encodeURIComponent(url)}`;
            window.open(posterUrl, '_blank', 'width=400,height=800');
        }

        // æäº¤æç°ç”³è¯·
        async function submitWithdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            const type = document.getElementById('withdrawType').value;
            const account = document.getElementById('withdrawAccount').value;
            const name = document.getElementById('accountName').value;

            if (!amount || amount < 10) {
                alert('æç°é‡‘é¢ä¸èƒ½å°‘äº10å…ƒ');
                return;
            }

            if (!account || !name) {
                alert('è¯·å¡«å†™å®Œæ•´çš„æç°ä¿¡æ¯');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/yuan/api/distribution/withdraw', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        withdrawal_type: type,
                        withdrawal_account: account,
                        account_name: name
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('æç°ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…å®¡æ ¸');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('withdrawAmount').value = '';
                    document.getElementById('withdrawAccount').value = '';
                    document.getElementById('accountName').value = '';
                    // åˆ·æ–°æ•°æ®
                    loadMyStats();
                } else {
                    alert(result.message || 'æç°ç”³è¯·å¤±è´¥');
                }
            } catch (error) {
                console.error('æç°ç”³è¯·å¤±è´¥:', error);
                alert('æç°ç”³è¯·å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ç”Ÿæˆæ´»ç æµ·æŠ¥ï¼ˆåŠ¨æ€äºŒç»´ç ï¼Œå¯åå°åˆ‡æ¢åŸŸåï¼‰
        async function generateDynamicQRCode() {
            const code = document.getElementById('invitationCode').textContent;
            const url = document.getElementById('invitationUrl').textContent;

            if (!code || code === 'åŠ è½½ä¸­...') {
                alert('è¯·ç­‰å¾…é‚€è¯·ç åŠ è½½å®Œæˆ');
                return;
            }

            try {
                // è°ƒç”¨åç«¯APIåˆ›å»ºæ´»ç 
                const response = await fetch('/yuan/api/qrcode/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        invitationCode: code,
                        targetUrl: url
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ä½¿ç”¨æ´»ç çŸ­é“¾æ¥ç”ŸæˆäºŒç»´ç æµ·æŠ¥
                    const qrcodeUrl = `/yuan/dynamic-qrcode-poster.html?code=${code}&shortUrl=${encodeURIComponent(result.shortUrl)}&qrcodeId=${result.qrcodeId}`;
                    window.open(qrcodeUrl, '_blank', 'width=500,height=800');
                } else {
                    alert(result.message || 'ç”Ÿæˆæ´»ç å¤±è´¥');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ´»ç å¤±è´¥:', error);
                alert('ç”Ÿæˆæ´»ç å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
    </script>
</body>
</html>
