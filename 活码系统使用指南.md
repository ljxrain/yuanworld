# 活码系统使用指南

## 🎯 什么是活码？

**活码**（Dynamic QR Code）是一种**可以后台切换跳转地址**的二维码技术。

### 普通二维码 vs 活码

| 对比项 | 普通二维码 | 活码 |
|--------|------------|------|
| 跳转地址 | 固定，生成后无法修改 | 可后台随时修改 |
| 被封后 | 需要重新生成二维码图片 | 后台切换域名，图片不变 |
| 数据统计 | 无法统计 | 可查看扫码次数、来源等 |
| 成本 | 低（但被封后需重新推广） | 稍高（但长期成本更低） |

### 核心原理

```
普通二维码：
扫码 → 直接跳转 http://abc.com/register?code=8888
      ↑ 域名被封，二维码失效

活码：
扫码 → 短链接 http://49.232.220.223/q/QA1B2C3D
      ↓
    数据库查询当前可用域名
      ↓
    301跳转到 http://xyz.com/register?code=8888
      ↑ 域名被封后，后台修改数据库，跳转到新域名
```

---

## 🚀 快速开始

### 1. 生成活码

**入口：** 分销中心 → 点击"🔥 活码海报（防封）"

**步骤：**
1. 系统自动调用 `/api/qrcode/create` API
2. 生成唯一活码标识（如 `QA1B2C3D`）
3. 创建短链接：`http://49.232.220.223/q/QA1B2C3D`
4. 打开海报页面，显示二维码

**API调用示例：**
```javascript
POST /yuan/api/qrcode/create
Headers: {
    Authorization: Bearer ${token}
}
Body: {
    invitationCode: "ABC12345",
    targetUrl: "http://49.232.220.223/yuan/?code=ABC12345"
}

Response: {
    success: true,
    qrcodeId: "QA1B2C3D",
    shortUrl: "http://49.232.220.223/q/QA1B2C3D",
    shortPath: "/q/QA1B2C3D",
    targetUrl: "http://49.232.220.223/yuan/?code=ABC12345",
    currentDomain: "49.232.220.223"
}
```

### 2. 分享海报

**保存图片：**
- 点击"💾 保存海报"
- 图片保存后可发到朋友圈、微信群等

**复制短链接：**
- 点击"📋 复制短链接"
- 可直接发送短链接

### 3. 用户扫码流程

**场景A：在微信内扫码**
```
用户扫码 → 访问 /q/QA1B2C3D
         ↓
    检测到微信浏览器
         ↓
    显示引导页："请在浏览器中打开"
         ↓
    用户点击右上角 → 在浏览器打开
         ↓
    跳转到目标页面，绑定邀请关系
```

**场景B：在外部浏览器扫码**
```
用户扫码 → 访问 /q/QA1B2C3D
         ↓
    检测到非微信浏览器
         ↓
    直接302跳转到目标页面
```

---

## 🛡️ 域名被封后的处理流程

### 自动检测（未来功能）

系统会定期检测域名是否被封：
- 每5分钟自动访问一次
- 检测HTTP状态码
- 检测是否被微信拦截

### 手动标记（当前方式）

**场景：** 用户反馈扫码后提示"已停止访问该网页"

**步骤1：标记域名为已封禁**

```bash
POST /yuan/api/qrcode/mark-blocked
Headers: {
    Authorization: Bearer ${token}
}
Body: {
    domainId: 1  # 域名ID
}
```

**步骤2：添加新域名到域名池**

```bash
POST /yuan/api/qrcode/add-domain
Headers: {
    Authorization: Bearer ${token}
}
Body: {
    domain: "new-domain.com",
    domainType: "cannon",  # cannon(炮灰), main(主站), high_trust(高权重)
    priority: 50           # 优先级 1-100
}
```

**步骤3：批量切换活码到新域名**

```bash
POST /yuan/api/qrcode/batch-switch
Headers: {
    Authorization: Bearer ${token}
}
Body: {
    oldDomainId: 1,  # 被封的域名ID
    newDomainId: 5   # 新域名ID
}
```

**结果：**
- 所有使用旧域名的活码自动切换到新域名
- 用户手中的二维码图片无需重新生成
- 扫码后跳转到新域名

---

## 📊 数据库表结构

### 1. domain_pool（域名池）

存储所有可用域名，支持域名轮换。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL | 主键 |
| domain | VARCHAR(100) | 域名（如 abc.com） |
| domain_type | VARCHAR(20) | 类型：cannon(炮灰), main(主站), high_trust(高权重) |
| status | VARCHAR(20) | 状态：active(可用), blocked(已封), testing(测试中) |
| priority | INTEGER | 优先级（1-100，越高越优先） |
| blocked_at | TIMESTAMP | 被封时间 |
| total_visits | INTEGER | 总访问次数 |
| block_count | INTEGER | 被封次数 |

**初始数据：**
```sql
('49.232.220.223', 'main', 'active', 100, '主站IP地址')
('docs.qq.com', 'high_trust', 'active', 90, '腾讯文档（高权重）')
('shimo.im', 'high_trust', 'active', 85, '石墨文档（高权重）')
```

### 2. dynamic_qrcodes（活码表）

每个活码记录，关联用户和域名。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL | 主键 |
| code | VARCHAR(20) | 活码标识（如 QA1B2C3D） |
| user_id | UUID | 关联用户 |
| invitation_code | VARCHAR(20) | 关联邀请码 |
| target_url | TEXT | 目标URL |
| current_domain_id | INTEGER | 当前使用的域名ID |
| short_path | VARCHAR(50) | 短路径（如 /q/QA1B2C3D） |
| is_active | BOOLEAN | 是否激活 |
| total_scans | INTEGER | 总扫描次数 |
| unique_scans | INTEGER | 独立扫描次数 |
| last_scan_at | TIMESTAMP | 最后扫描时间 |

### 3. qrcode_scan_logs（扫码日志）

记录每次扫码行为，用于数据分析。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL | 主键 |
| qrcode_id | INTEGER | 活码ID |
| domain_id | INTEGER | 域名ID |
| user_agent | TEXT | 浏览器UA |
| ip_address | VARCHAR(50) | 访问IP |
| is_wechat | BOOLEAN | 是否微信内打开 |
| scan_time | TIMESTAMP | 扫描时间 |
| redirect_success | BOOLEAN | 是否跳转成功 |

---

## 📱 完整的防封方案组合

### 方案组合：三种方式并存

#### 1. 口令复制（100%防封，推荐）

**优势：**
- 纯文本，微信无法检测
- 零成本
- 用户习惯（淘宝、抖音已教育市场）

**劣势：**
- 需要用户手动复制粘贴
- 视觉冲击力不如海报

**使用场景：**
- 微信群、朋友圈文字分享
- QQ、短信、邮件

#### 2. 活码海报（抗封，易操作）

**优势：**
- 视觉效果好
- 扫码方便
- 被封后可后台切换域名

**劣势：**
- 需要域名池（有成本）
- 依然有被封风险

**使用场景：**
- 朋友圈海报
- 线下展示（门店、展会）
- 公众号推文

#### 3. 普通海报（口令二维码）

**优势：**
- 100%防封（二维码内容是文本）
- 视觉效果好

**劣势：**
- 需要用户扫码后手动复制
- 多一步操作

**使用场景：**
- 微信朋友圈
- 公众号文章

---

## 🔧 高级功能（未来规划）

### 1. 腾讯文档集成

**原理：** 使用腾讯文档作为中间页

```
扫码 → https://docs.qq.com/doc/xxx
     ↓
    文档内容："点击链接开始体验"
     ↓
    用户点击链接 → 跳转到目标页面
```

**优势：**
- 微信不敢封腾讯文档
- 可随时修改文档内容
- 高权重域名

**API接口：**
```bash
POST /yuan/api/qrcode/create-tencent-doc
Body: {
    invitationCode: "ABC12345",
    targetUrl: "..."
}

Response: {
    success: true,
    docUrl: "https://docs.qq.com/doc/xxxxx",
    qrcodeUrl: "..."
}
```

### 2. 域名健康自动检测

**功能：**
- 每5分钟检测一次所有active域名
- 检测HTTP状态码
- 模拟微信UA访问，检测是否被拦截
- 自动标记被封域名
- 触发告警（邮件/短信）

**实现：**
```javascript
// 定时任务（cron）
setInterval(async () => {
    const domains = await getDomains({ status: 'active' });

    for (const domain of domains) {
        const isBlocked = await checkDomainHealth(domain);

        if (isBlocked) {
            await markDomainBlocked(domain.id);
            await sendAlert(`域名 ${domain.domain} 已被封禁`);

            // 自动切换
            const newDomain = await getNextAvailableDomain();
            await batchSwitchDomain(domain.id, newDomain.id);
        }
    }
}, 5 * 60 * 1000); // 5分钟
```

### 3. 活码管理后台

**功能：**
- 可视化查看所有活码
- 查看扫码数据统计
- 一键切换域名
- 批量操作

**页面：** `/yuan/admin/qrcode-manager.html`

---

## 💰 成本分析

### 域名池方案

**假设：**
- 每个域名成本：50元/年
- 预计被封速度：1个/周（推广力度大时）
- 准备域名数量：52个（一年用量）

**年成本：**
```
域名成本：52 × 50 = 2600元/年
```

### 对比：不使用活码

**场景：** 每次被封后重新生成普通二维码

**成本：**
```
重新设计海报：500元/次
重新印刷物料：2000元/次
重新推广传播：时间成本（无法估量）

一年被封10次 × (500 + 2000) = 25000元
```

**结论：** 活码方案**节省90%成本**！

---

## 📈 数据统计功能

### 查看我的活码列表

```bash
GET /yuan/api/qrcode/my-codes
Headers: {
    Authorization: Bearer ${token}
}

Response: {
    success: true,
    codes: [
        {
            id: 1,
            code: "QA1B2C3D",
            invitation_code: "ABC12345",
            target_url: "http://...",
            short_path: "/q/QA1B2C3D",
            is_active: true,
            total_scans: 158,      # 总扫描次数
            unique_scans: 95,      # 独立用户数
            created_at: "2025-12-31",
            last_scan_at: "2025-12-31 10:30:00",
            current_domain: "49.232.220.223",
            domain_status: "active"
        }
    ]
}
```

### 查看域名列表

```bash
GET /yuan/api/qrcode/domains
Headers: {
    Authorization: Bearer ${token}
}

Response: {
    success: true,
    domains: [
        {
            id: 1,
            domain: "49.232.220.223",
            domain_type: "main",
            status: "active",
            priority: 100,
            total_visits: 5280,
            block_count: 0,
            blocked_at: null
        },
        {
            id: 2,
            domain: "old-domain.com",
            domain_type: "cannon",
            status: "blocked",
            priority: 50,
            total_visits: 1200,
            block_count: 1,
            blocked_at: "2025-12-30 15:00:00"
        }
    ]
}
```

---

## 🎯 最佳实践

### 1. 域名池准备

**建议配置：**
```
- 主站IP：1个（高优先级）
- 高权重域名：2-3个（腾讯文档、石墨文档等）
- 炮灰域名：10-20个（便宜的.top, .xyz等）
```

**域名类型选择：**
- .com / .cn - 贵但权重高（100-200元/年）
- .top / .xyz / .icu - 便宜（5-30元/年）
- 短域名（3-4位）- 更易记但贵（500+元/年）

### 2. 监控告警

**设置告警规则：**
- 域名被封 → 立即通知
- 活码扫描失败率 > 50% → 警告
- 某个活码24小时无扫描 → 提示（可能失效）

### 3. 用户教育

**在海报上添加说明：**
```
✅ 如果提示"已停止访问该网页"
   请联系客服获取最新链接
   或使用口令复制方式
```

---

## 🚨 常见问题

### Q1: 活码的短链接会被封吗？

**A:** 会！但**被封后可以后台切换域名**，这就是活码的核心价值。

**处理流程：**
1. 用户反馈无法访问
2. 管理员标记域名为已封禁
3. 添加新域名到域名池
4. 批量切换所有活码到新域名
5. 用户手中的二维码图片**无需重新生成**

### Q2: 如何知道域名被封了？

**方式1：用户反馈**
- 用户扫码后提示"已停止访问该网页"

**方式2：自动检测（未来功能）**
- 系统定期检测域名状态
- 自动标记并切换

**方式3：手动测试**
- 管理员定期扫码测试
- 在微信内打开短链接测试

### Q3: 需要准备多少个域名？

**取决于推广力度：**

```
小规模推广（日扫码 < 100）：
- 主站IP：1个
- 备用域名：5个
- 预计被封速度：1个/月

中等规模推广（日扫码 100-1000）：
- 主站IP：1个
- 备用域名：20个
- 预计被封速度：1个/周

大规模推广（日扫码 > 1000）：
- 主站IP：1个
- 备用域名：50+个
- 预计被封速度：1个/天
- 建议配合高权重域名（腾讯文档等）
```

### Q4: 腾讯文档会不会也被封？

**A:** 理论上会，但概率极低。

**原因：**
- 腾讯文档是腾讯自家产品
- 微信不敢随便封腾讯系域名
- 即使封，影响面太大，会很快解封

**最坏情况：**
- 封的是你的文档ID，不是整个域名
- 可以重新创建文档

---

## 📝 总结

### 核心价值

**活码 = 二维码图片不变 + 后台可切换跳转地址**

### 适用场景

✅ **推荐使用活码：**
- 大规模推广（印刷物料多）
- 长期推广（海报重复使用）
- 线下推广（门店展示、展会）

❌ **不推荐使用活码：**
- 小规模测试（准备一两个域名即可）
- 纯线上推广（口令复制更方便）

### 三种方案对比

| 方案 | 防封效果 | 用户体验 | 成本 | 推荐场景 |
|------|----------|----------|------|----------|
| 口令复制 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ¥0 | 微信群、朋友圈文字 |
| 活码海报 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ¥2600/年 | 线下、大规模推广 |
| 口令二维码 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ¥0 | 朋友圈海报 |

### 最终建议

**组合使用，效果最佳：**
1. **主推：活码海报** - 视觉效果好，抗封能力强
2. **备用：口令复制** - 100%防封，零成本
3. **辅助：口令二维码** - 兼顾视觉和防封

---

*最后更新：2025-12-31*
*作者：Claude Code*
