# åˆ†é”€ç³»ç»Ÿæµ‹è¯•å¿«é€ŸæŒ‡å—

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### âš ï¸ å½“å‰ç³»ç»Ÿå­˜åœ¨çš„é—®é¢˜ï¼ˆéœ€è¦å…ˆä¿®å¤ï¼‰

1. **æ³¨å†Œé¡µé¢ä¸å­˜åœ¨** - é‚€è¯·é“¾æ¥æŒ‡å‘çš„ `register.html` ä¸å­˜åœ¨
2. **æ³¨å†Œæ—¶æœªè¯»å–é‚€è¯·ç ** - URL å‚æ•°ä¸­çš„é‚€è¯·ç æ²¡æœ‰è¢«ä½¿ç”¨
3. **æ”¯ä»˜å›è°ƒæœªè§¦å‘ä½£é‡‘** - éœ€è¦æ£€æŸ¥ä¸ƒç›¸æ”¯ä»˜å›è°ƒæ˜¯å¦è°ƒç”¨ä½£é‡‘åˆ†é…å‡½æ•°

## ğŸ¯ å¿«é€Ÿæµ‹è¯•æ­¥éª¤ï¼ˆå½“å‰å¯ç”¨åŠŸèƒ½ï¼‰

### æ­¥éª¤1ï¼šæ³¨å†Œæµ‹è¯•è´¦å·

**ä½¿ç”¨3ä¸ªä¸åŒçš„æµè§ˆå™¨ï¼ˆæˆ–æ— ç—•æ¨¡å¼ï¼‰åˆ†åˆ«æ³¨å†Œï¼š**

1. **è´¦å·Aï¼ˆä¸€çº§æ¨å¹¿å‘˜ï¼‰**
   - è®¿é—®ï¼š`http://49.232.220.223/yuan/create.html`
   - ç‚¹å‡»"ç™»å½•/æ³¨å†Œ"
   - æ³¨å†Œä¿¡æ¯ï¼š
     - ç”¨æˆ·åï¼š`test_user_A`
     - é‚®ç®±ï¼šå¯ç•™ç©º
     - å¯†ç ï¼š`123456`

2. **è´¦å·Bï¼ˆäºŒçº§æ¨å¹¿å‘˜ï¼‰**
   - ç”¨æˆ·åï¼š`test_user_B`
   - å¯†ç ï¼š`123456`

3. **è´¦å·Cï¼ˆä¹°å®¶ï¼‰**
   - ç”¨æˆ·åï¼š`test_user_C`
   - å¯†ç ï¼š`123456`

---

### æ­¥éª¤2ï¼šè·å–é‚€è¯·ç 

**è´¦å·Aç™»å½•åï¼š**
1. è®¿é—®ï¼š`http://49.232.220.223/yuan/distribution.html`
2. è®°å½•é‚€è¯·ç ï¼ˆä¾‹å¦‚ï¼š`ABC12345`ï¼‰

**è´¦å·Bç™»å½•åï¼š**
1. è®¿é—®ï¼š`http://49.232.220.223/yuan/distribution.html`
2. è®°å½•é‚€è¯·ç ï¼ˆä¾‹å¦‚ï¼š`DEF67890`ï¼‰

---

### æ­¥éª¤3ï¼šæ‰‹åŠ¨ç»‘å®šé‚€è¯·å…³ç³»ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

ç”±äºè‡ªåŠ¨ç»‘å®šåŠŸèƒ½æœªå®ç°ï¼Œéœ€è¦é€šè¿‡APIæ‰‹åŠ¨ç»‘å®šï¼š

**ç»‘å®šè´¦å·Båˆ°è´¦å·Aï¼š**
```javascript
// è´¦å·Bçš„æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
const token = localStorage.getItem('token');
const inviterCode = 'ABC12345'; // è´¦å·Açš„é‚€è¯·ç 

fetch('/yuan/api/distribution/bind-inviter', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ inviter_code: inviterCode })
}).then(r => r.json()).then(console.log);
```

**ç»‘å®šè´¦å·Cåˆ°è´¦å·Bï¼š**
```javascript
// è´¦å·Cçš„æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
const token = localStorage.getItem('token');
const inviterCode = 'DEF67890'; // è´¦å·Bçš„é‚€è¯·ç 

fetch('/yuan/api/distribution/bind-inviter', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ inviter_code: inviterCode })
}).then(r => r.json()).then(console.log);
```

---

### æ­¥éª¤4ï¼šå……å€¼æµ‹è¯•ï¼ˆäº§ç”Ÿä½£é‡‘ï¼‰

**è´¦å·Cè¿›è¡Œå……å€¼ï¼š**
1. è®¿é—®ï¼š`http://49.232.220.223/yuan/payment.html?type=balance&amount=10`
2. é€‰æ‹©Â¥10å……å€¼
3. ä½¿ç”¨ä¸ƒç›¸æ”¯ä»˜å®Œæˆæ”¯ä»˜
4. ç­‰å¾…æ”¯ä»˜å›è°ƒ

---

### æ­¥éª¤5ï¼šéªŒè¯æ•°æ®åº“

è¿æ¥åˆ°æœåŠ¡å™¨æ‰§è¡Œä»¥ä¸‹SQLæŸ¥è¯¢ï¼š

#### æŸ¥çœ‹é‚€è¯·å…³ç³»é“¾
```bash
ssh yuan "sudo -u postgres psql yuan_world -c \"
SELECT
    u1.username AS ç”¨æˆ·,
    u2.username AS é‚€è¯·äºº,
    ui.created_at AS ç»‘å®šæ—¶é—´
FROM user_invitations ui
LEFT JOIN users u1 ON ui.user_id = u1.id
LEFT JOIN users u2 ON ui.inviter_id = u2.id
WHERE u1.username IN ('test_user_A', 'test_user_B', 'test_user_C')
ORDER BY ui.created_at DESC;
\""
```

**é¢„æœŸç»“æœ**:
```
     ç”¨æˆ·      |    é‚€è¯·äºº      |       ç»‘å®šæ—¶é—´
---------------|----------------|--------------------
 test_user_C   | test_user_B    | 2026-01-02 XX:XX:XX
 test_user_B   | test_user_A    | 2026-01-02 XX:XX:XX
```

---

#### æŸ¥çœ‹ä½£é‡‘è®°å½•
```bash
ssh yuan "sudo -u postgres psql yuan_world -c \"
SELECT
    buyer.username AS ä¹°å®¶,
    distributor.username AS åˆ†é”€å•†,
    dc.level AS çº§åˆ«,
    dc.order_amount AS è®¢å•é‡‘é¢,
    dc.commission_amount AS ä½£é‡‘é‡‘é¢,
    dc.created_at AS æ—¶é—´
FROM distribution_commissions dc
LEFT JOIN users buyer ON dc.buyer_id = buyer.id
LEFT JOIN users distributor ON dc.distributor_id = distributor.id
WHERE buyer.username = 'test_user_C'
ORDER BY dc.created_at DESC;
\""
```

**é¢„æœŸç»“æœ**ï¼ˆå¦‚æœä½£é‡‘åˆ†é…æˆåŠŸï¼‰:
```
     ä¹°å®¶      |    åˆ†é”€å•†      | çº§åˆ« | è®¢å•é‡‘é¢ | ä½£é‡‘é‡‘é¢ |        æ—¶é—´
---------------|----------------|------|----------|----------|--------------------
 test_user_C   | test_user_B    | 1    | 10.00    | 3.00     | 2026-01-02 XX:XX:XX
 test_user_C   | test_user_A    | 2    | 10.00    | 2.00     | 2026-01-02 XX:XX:XX
```

---

#### æŸ¥çœ‹ä½£é‡‘è´¦æˆ·
```bash
ssh yuan "sudo -u postgres psql yuan_world -c \"
SELECT
    u.username AS ç”¨æˆ·å,
    uca.total_commission AS æ€»ä½£é‡‘,
    uca.available_commission AS å¯ç”¨ä½£é‡‘,
    uca.level1_invited AS ä¸€çº§ä¸‹çº¿,
    uca.level2_invited AS äºŒçº§ä¸‹çº¿
FROM user_commission_accounts uca
LEFT JOIN users u ON uca.user_id = u.id
WHERE u.username IN ('test_user_A', 'test_user_B')
ORDER BY u.username;
\""
```

**é¢„æœŸç»“æœ**:
```
   ç”¨æˆ·å      | æ€»ä½£é‡‘ | å¯ç”¨ä½£é‡‘ | ä¸€çº§ä¸‹çº¿ | äºŒçº§ä¸‹çº¿
---------------|--------|----------|----------|----------
 test_user_A   | 2.00   | 2.00     | 1        | 1
 test_user_B   | 3.00   | 3.00     | 1        | 0
```

---

## ğŸ” é—®é¢˜æ’æŸ¥

### å¦‚æœé‚€è¯·å…³ç³»æœªå»ºç«‹
```sql
-- æ£€æŸ¥usersè¡¨çš„inviter_codeå­—æ®µ
SELECT username, invitation_code, inviter_code FROM users
WHERE username IN ('test_user_A', 'test_user_B', 'test_user_C');
```

### å¦‚æœæ²¡æœ‰ä½£é‡‘è®°å½•
1. æ£€æŸ¥æ”¯ä»˜è®¢å•æ˜¯å¦æˆåŠŸï¼š
```bash
ssh yuan "sudo -u postgres psql yuan_world -c \"
SELECT out_trade_no, user_id, total_amount, status, paid_at
FROM payment_orders
ORDER BY created_at DESC LIMIT 5;
\""
```

2. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š
```bash
ssh yuan "pm2 logs yuan-world-app --lines 50 | grep -i commission"
```

---

## ğŸ“Š ä½£é‡‘é…ç½®æŸ¥è¯¢

```bash
ssh yuan "sudo -u postgres psql yuan_world -c \"
SELECT level, commission_rate, is_active
FROM distribution_config
ORDER BY level;
\""
```

**é¢„æœŸæ˜¾ç¤º**:
```
 level | commission_rate | is_active
-------|-----------------|----------
     1 |           30.00 | t
     2 |           20.00 | t
     3 |           10.00 | t
```

---

## âœ… æµ‹è¯•æˆåŠŸæ ‡å‡†

1. âœ… ä¸‰ä¸ªè´¦å·æˆåŠŸæ³¨å†Œ
2. âœ… é‚€è¯·å…³ç³»å»ºç«‹æˆåŠŸï¼ˆBâ†’Aï¼ŒCâ†’Bï¼‰
3. âœ… è´¦å·Cå……å€¼Â¥10æˆåŠŸ
4. âœ… è´¦å·Bè·å¾—Â¥3ä½£é‡‘ï¼ˆ30%ï¼‰
5. âœ… è´¦å·Aè·å¾—Â¥2ä½£é‡‘ï¼ˆ20%ï¼‰
6. âœ… åˆ†é”€ä¸­å¿ƒé¡µé¢æ˜¾ç¤ºæ­£ç¡®æ•°æ®

---

## ğŸ“ æµ‹è¯•è®°å½•è¡¨æ ¼

| é¡¹ç›® | è´¦å·A | è´¦å·B | è´¦å·C | çŠ¶æ€ |
|------|-------|-------|-------|------|
| ç”¨æˆ·å | test_user_A | test_user_B | test_user_C | âœ… |
| é‚€è¯·ç  | ABC12345 | DEF67890 | GHI11111 | âœ… |
| ä¸Šçº§é‚€è¯·äºº | - | test_user_A | test_user_B | â³ |
| ä¸€çº§ä¸‹çº¿æ•° | 1 | 1 | 0 | â³ |
| äºŒçº§ä¸‹çº¿æ•° | 1 | 0 | 0 | â³ |
| å……å€¼é‡‘é¢ | Â¥0 | Â¥0 | Â¥10 | â³ |
| è·å¾—ä½£é‡‘ | Â¥2 | Â¥3 | Â¥0 | â³ |

---

## ğŸ› ï¸ éœ€è¦ä¿®å¤çš„åŠŸèƒ½ï¼ˆå¼€å‘ä»»åŠ¡ï¼‰

### ä¼˜å…ˆçº§1ï¼šæ³¨å†Œæ—¶è‡ªåŠ¨ç»‘å®šé‚€è¯·ç 
- [ ] ä¿®æ”¹é‚€è¯·é“¾æ¥æŒ‡å‘ create.html?code=XXX
- [ ] create.html è¯»å– URL å‚æ•°è·å–é‚€è¯·ç 
- [ ] æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨è°ƒç”¨ç»‘å®šAPI

### ä¼˜å…ˆçº§2ï¼šæ”¯ä»˜å›è°ƒè§¦å‘ä½£é‡‘åˆ†é…
- [ ] æ‰¾åˆ°ä¸ƒç›¸æ”¯ä»˜å›è°ƒå¤„ç†å‡½æ•°
- [ ] åœ¨æ”¯ä»˜æˆåŠŸåè°ƒç”¨ calculateAndDistributeCommission
- [ ] æ·»åŠ ä½£é‡‘åˆ†é…æ—¥å¿—

### ä¼˜å…ˆçº§3ï¼šå®Œå–„åˆ†é”€æ•°æ®å±•ç¤º
- [ ] åˆ†é”€ä¸­å¿ƒæ˜¾ç¤ºä¸‹çº§åˆ—è¡¨
- [ ] åˆ†é”€ä¸­å¿ƒæ˜¾ç¤ºä½£é‡‘æ˜ç»†
- [ ] æç°åŠŸèƒ½æµ‹è¯•
