<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å……å€¼ä¸­å¿ƒ - åšä¸–ç•Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 36px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .payment-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .tab-content.active {
            display: block;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .option-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .option-price {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
            margin: 15px 0;
        }

        .option-desc {
            color: #666;
            font-size: 14px;
        }

        .payment-method {
            margin: 30px 0;
        }

        .payment-method h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .method-buttons {
            display: flex;
            gap: 15px;
        }

        .method-btn {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .method-btn:hover {
            border-color: #667eea;
        }

        .method-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .method-icon {
            font-size: 32px;
        }

        .method-name {
            font-size: 18px;
            font-weight: bold;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .custom-amount {
            margin: 20px 0;
            display: none;
        }

        .custom-amount.show {
            display: block;
        }

        .custom-amount input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .payment-options {
                grid-template-columns: 1fr;
            }

            .method-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’° å……å€¼ä¸­å¿ƒ</h1>

        <div class="payment-tabs">
            <button class="tab-btn active" onclick="switchTab('balance')">ä½™é¢å……å€¼</button>
            <button class="tab-btn" onclick="switchTab('vip')">VIPä¼šå‘˜</button>
            <button class="tab-btn" onclick="switchTab('preview')">è´­ä¹°é¢„è§ˆ</button>
        </div>

        <!-- ä½™é¢å……å€¼ -->
        <div id="balance-tab" class="tab-content active">
            <h2 style="margin-bottom: 20px;">ğŸ’µ ä½™é¢å……å€¼</h2>
            <div class="payment-options">
                <div class="option-card" onclick="selectOption('balance', 10)">
                    <div class="option-title">ä½“éªŒå……å€¼</div>
                    <div class="option-price">Â¥10</div>
                    <div class="option-desc">é€‚åˆæ–°ç”¨æˆ·ä½“éªŒ</div>
                </div>
                <div class="option-card" onclick="selectOption('balance', 50)">
                    <div class="option-title">å°é¢å……å€¼</div>
                    <div class="option-price">Â¥50</div>
                    <div class="option-desc">æ»¡è¶³åŸºæœ¬éœ€æ±‚</div>
                </div>
                <div class="option-card" onclick="selectOption('balance', 100)">
                    <div class="option-title">æ ‡å‡†å……å€¼</div>
                    <div class="option-price">Â¥100</div>
                    <div class="option-desc">æœ€å—æ¬¢è¿</div>
                </div>
                <div class="option-card" onclick="selectOption('balance', 'custom')">
                    <div class="option-title">è‡ªå®šä¹‰</div>
                    <div class="option-price">Â¥?</div>
                    <div class="option-desc">è¾“å…¥é‡‘é¢</div>
                </div>
            </div>

            <div class="custom-amount" id="custom-balance">
                <label>è¾“å…¥å……å€¼é‡‘é¢:</label>
                <input type="number" id="balance-custom-amount" min="1" step="0.01" placeholder="è¯·è¾“å…¥é‡‘é¢">
            </div>

            <div class="payment-method">
                <h3>é€‰æ‹©æ”¯ä»˜æ–¹å¼:</h3>
                <div class="method-buttons">
                    <div class="method-btn selected" onclick="selectPaymentMethod('alipay')">
                        <div class="method-icon">ğŸ’³</div>
                        <div class="method-name">æ”¯ä»˜å®</div>
                    </div>
                    <div class="method-btn" onclick="selectPaymentMethod('wxpay')">
                        <div class="method-icon">ğŸ’š</div>
                        <div class="method-name">å¾®ä¿¡æ”¯ä»˜</div>
                    </div>
                </div>
            </div>

            <div class="alert" id="balance-alert"></div>
            <div class="loading" id="balance-loading">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åˆ›å»ºè®¢å•...</p>
            </div>

            <button class="btn-submit" onclick="submitPayment('balance')">ç«‹å³å……å€¼</button>
        </div>

        <!-- VIPä¼šå‘˜ -->
        <div id="vip-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ‘‘ VIPä¼šå‘˜</h2>
            <div class="payment-options">
                <div class="option-card" onclick="selectOption('vip', 30)">
                    <div class="option-title">æœˆåº¦ä¼šå‘˜</div>
                    <div class="option-price">Â¥30</div>
                    <div class="option-desc">30å¤©VIPæƒé™</div>
                </div>
                <div class="option-card" onclick="selectOption('vip', 88)">
                    <div class="option-title">å­£åº¦ä¼šå‘˜</div>
                    <div class="option-price">Â¥88</div>
                    <div class="option-desc">90å¤©VIPæƒé™ (9æŠ˜)</div>
                </div>
                <div class="option-card" onclick="selectOption('vip', 288)">
                    <div class="option-title">å¹´åº¦ä¼šå‘˜</div>
                    <div class="option-price">Â¥288</div>
                    <div class="option-desc">365å¤©VIPæƒé™ (8æŠ˜)</div>
                </div>
            </div>

            <div class="payment-method">
                <h3>é€‰æ‹©æ”¯ä»˜æ–¹å¼:</h3>
                <div class="method-buttons">
                    <div class="method-btn selected" onclick="selectPaymentMethod('alipay')">
                        <div class="method-icon">ğŸ’³</div>
                        <div class="method-name">æ”¯ä»˜å®</div>
                    </div>
                    <div class="method-btn" onclick="selectPaymentMethod('wxpay')">
                        <div class="method-icon">ğŸ’š</div>
                        <div class="method-name">å¾®ä¿¡æ”¯ä»˜</div>
                    </div>
                </div>
            </div>

            <div class="alert" id="vip-alert"></div>
            <div class="loading" id="vip-loading">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åˆ›å»ºè®¢å•...</p>
            </div>

            <button class="btn-submit" onclick="submitPayment('vip')">å¼€é€šVIP</button>
        </div>

        <!-- è´­ä¹°é¢„è§ˆ -->
        <div id="preview-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ” è´­ä¹°é¢„è§ˆæ¬¡æ•°</h2>
            <div class="payment-options">
                <div class="option-card" onclick="selectOption('preview', 10)">
                    <div class="option-title">10æ¬¡é¢„è§ˆ</div>
                    <div class="option-price">Â¥5</div>
                    <div class="option-desc">ä½“éªŒå¥—é¤</div>
                </div>
                <div class="option-card" onclick="selectOption('preview', 50)">
                    <div class="option-title">50æ¬¡é¢„è§ˆ</div>
                    <div class="option-price">Â¥20</div>
                    <div class="option-desc">æ ‡å‡†å¥—é¤</div>
                </div>
                <div class="option-card" onclick="selectOption('preview', 100)">
                    <div class="option-title">100æ¬¡é¢„è§ˆ</div>
                    <div class="option-price">Â¥35</div>
                    <div class="option-desc">è¶…å€¼å¥—é¤</div>
                </div>
            </div>

            <div class="payment-method">
                <h3>é€‰æ‹©æ”¯ä»˜æ–¹å¼:</h3>
                <div class="method-buttons">
                    <div class="method-btn selected" onclick="selectPaymentMethod('alipay')">
                        <div class="method-icon">ğŸ’³</div>
                        <div class="method-name">æ”¯ä»˜å®</div>
                    </div>
                    <div class="method-btn" onclick="selectPaymentMethod('wxpay')">
                        <div class="method-icon">ğŸ’š</div>
                        <div class="method-name">å¾®ä¿¡æ”¯ä»˜</div>
                    </div>
                </div>
            </div>

            <div class="alert" id="preview-alert"></div>
            <div class="loading" id="preview-loading">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åˆ›å»ºè®¢å•...</p>
            </div>

            <button class="btn-submit" onclick="submitPayment('preview')">ç«‹å³è´­ä¹°</button>
        </div>
    </div>

    <script>
        let currentTab = 'balance';
        let selectedAmount = null;
        let selectedProductId = null;
        let paymentMethod = 'alipay';

        // é¡µé¢åŠ è½½æ—¶å¤„ç†URLå‚æ•°
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            const amount = urlParams.get('amount');
            const months = urlParams.get('months');
            const price = urlParams.get('price');

            if (type) {
                // åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾é¡µ
                if (type === 'balance' || type === 'vip' || type === 'preview') {
                    currentTab = type;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`[onclick="switchTab('${type}')"]`)?.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${type}-tab`)?.classList.add('active');
                }

                // é¢„è®¾é‡‘é¢
                if (type === 'balance' && amount) {
                    const amountValue = parseFloat(amount);
                    selectedAmount = amountValue;

                    // å¦‚æœæœ‰åŒ¹é…çš„é¢„è®¾é€‰é¡¹ï¼Œé€‰ä¸­å®ƒ
                    const presetOptions = [50, 100, 200, 500];
                    const matchingOption = presetOptions.find(opt => opt === amountValue);
                    if (matchingOption) {
                        document.querySelectorAll('#balance-tab .option-card').forEach((card, idx) => {
                            if (idx < presetOptions.length && presetOptions[idx] === matchingOption) {
                                card.classList.add('selected');
                            }
                        });
                    } else {
                        // ä½¿ç”¨è‡ªå®šä¹‰é‡‘é¢
                        document.querySelector('#balance-tab .option-card:last-child')?.classList.add('selected');
                        const customDiv = document.getElementById('custom-balance');
                        if (customDiv) {
                            customDiv.classList.add('show');
                            const customInput = document.getElementById('balance-custom-amount');
                            if (customInput) customInput.value = amountValue;
                        }
                    }
                }

                // é¢„è®¾VIPå¥—é¤
                if (type === 'vip' && months && price) {
                    const priceValue = parseFloat(price);
                    const monthsValue = parseInt(months);
                    selectedAmount = priceValue;

                    // æ ¹æ®æœˆä»½é€‰æ‹©å¯¹åº”çš„VIPé€‰é¡¹
                    const vipMap = { 1: 30, 3: 88, 12: 288 };
                    const matchingPrice = vipMap[monthsValue];
                    if (matchingPrice) {
                        const vipDays = { 30: 30, 88: 90, 288: 365 };
                        selectedProductId = vipDays[matchingPrice];

                        document.querySelectorAll('#vip-tab .option-card').forEach((card, idx) => {
                            const prices = [30, 88, 288];
                            if (prices[idx] === matchingPrice) {
                                card.classList.add('selected');
                            }
                        });
                    }
                }
            }
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;

            // æ›´æ–°æ ‡ç­¾æŒ‰é’®
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');

            // é‡ç½®é€‰æ‹©
            selectedAmount = null;
            selectedProductId = null;
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
        }

        // é€‰æ‹©å¥—é¤
        function selectOption(type, value) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll(`#${type}-tab .option-card`).forEach(card => {
                card.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            event.currentTarget.classList.add('selected');

            if (value === 'custom') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰é‡‘é¢è¾“å…¥
                document.getElementById(`custom-${type}`).classList.add('show');
                selectedAmount = null;
                selectedProductId = null;
            } else {
                // éšè—è‡ªå®šä¹‰é‡‘é¢è¾“å…¥
                const customDiv = document.getElementById(`custom-${type}`);
                if (customDiv) {
                    customDiv.classList.remove('show');
                }

                // è®¾ç½®é‡‘é¢å’Œäº§å“ID
                if (type === 'balance') {
                    selectedAmount = value;
                    selectedProductId = null;
                } else if (type === 'vip') {
                    const vipDays = { 30: 30, 88: 90, 288: 365 };
                    selectedAmount = value;
                    selectedProductId = vipDays[value];
                } else if (type === 'preview') {
                    const previewPrices = { 10: 5, 50: 20, 100: 35 };
                    selectedAmount = previewPrices[value];
                    selectedProductId = value;
                }
            }
        }

        // é€‰æ‹©æ”¯ä»˜æ–¹å¼
        function selectPaymentMethod(method) {
            paymentMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(type, message, isError = false) {
            const alertDiv = document.getElementById(`${type}-alert`);
            alertDiv.className = `alert ${isError ? 'alert-error' : 'alert-success'} show`;
            alertDiv.textContent = message;

            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 5000);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function toggleLoading(type, show) {
            const loadingDiv = document.getElementById(`${type}-loading`);
            if (show) {
                loadingDiv.classList.add('show');
            } else {
                loadingDiv.classList.remove('show');
            }
        }

        // æäº¤æ”¯ä»˜
        async function submitPayment(type) {
            try {
                // è·å–é‡‘é¢
                let amount = selectedAmount;
                if (!amount) {
                    const customInput = document.getElementById(`${type}-custom-amount`);
                    if (customInput && customInput.value) {
                        amount = parseFloat(customInput.value);
                    }
                }

                // éªŒè¯
                if (!amount || amount <= 0) {
                    showAlert(type, 'è¯·é€‰æ‹©æˆ–è¾“å…¥é‡‘é¢', true);
                    return;
                }

                if (!paymentMethod) {
                    showAlert(type, 'è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼', true);
                    return;
                }

                // è·å–token
                const token = localStorage.getItem('token');
                if (!token) {
                    showAlert(type, 'è¯·å…ˆç™»å½•', true);
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 1500);
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                toggleLoading(type, true);

                // æ„å»ºè¯·æ±‚æ•°æ®
                const productNames = {
                    balance: `ä½™é¢å……å€¼ Â¥${amount}`,
                    vip: `VIPä¼šå‘˜ ${selectedProductId}å¤©`,
                    preview: `é¢„è§ˆæ¬¡æ•° ${selectedProductId}æ¬¡`
                };

                const requestData = {
                    payment_type: paymentMethod,
                    amount: amount,
                    product_name: productNames[type],
                    product_type: type,
                    product_id: selectedProductId ? String(selectedProductId) : null,
                    device: /mobile/i.test(navigator.userAgent) ? 'mobile' : 'pc'
                };

                // å‘é€è¯·æ±‚
                const response = await fetch('/yuan/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                toggleLoading(type, false);

                if (result.success && result.data.pay_url) {
                    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                    window.location.href = result.data.pay_url;
                } else {
                    showAlert(type, result.message || 'åˆ›å»ºè®¢å•å¤±è´¥', true);
                }

            } catch (error) {
                console.error('æ”¯ä»˜å¤±è´¥:', error);
                toggleLoading(type, false);
                showAlert(type, 'æ”¯ä»˜è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', true);
            }
        }
    </script>
</body>
</html>
