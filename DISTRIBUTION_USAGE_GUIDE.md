# 三级分销系统使用指南

## 系统已完成部署 ✅

### 已实现的功能

#### 1. 三级分销核心功能
- ✅ 邀请码自动生成（8位大写字母+数字）
- ✅ 三级关系追踪（30%/10%/5% 佣金比例）
- ✅ 佣金自动计算和分配
- ✅ 佣金账户管理
- ✅ 提现申请功能
- ✅ 团队成员统计

#### 2. 微信防封方案（已实现）

**方案一：口令复制分享（100%防封）✅**
- 类似淘宝/抖音的口令模式
- 文本格式：`🎨 #博世界AI8888#`
- 纯文本消息，微信不拦截
- 自动剪贴板检测
- 智能弹窗引导

**方案二：二维码海报 + 中间页引导 ✅**
- 精美二维码海报生成
- 中间页检测微信浏览器
- 引导用户在外部浏览器打开

### 使用流程

#### 作为分销者（推广者）

1. **访问分销中心**
   - 登录后进入用户中心
   - 点击"💰 赚佣金"卡片
   - 或直接访问：`http://49.232.220.223/yuan/distribution.html`

2. **获取邀请码**
   - 系统自动生成唯一邀请码（如：`ABC12345`）
   - 邀请链接：`http://49.232.220.223/yuan/?code=ABC12345`

3. **分享方式（3种）**

   **方式1：口令分享（推荐，100%防封）**
   - 点击"📋 口令分享（防封100%）"按钮
   - 一键复制口令：`🎨 #博世界AIABC12345#\n复制这段话，打开手机浏览器访问...`
   - 直接发送到微信/QQ/短信
   - 好友复制后打开网站自动检测

   **方式2：二维码海报**
   - 点击"🖼️ 海报二维码"
   - 生成精美海报
   - 保存图片分享到朋友圈/微信

   **方式3：直接复制链接**
   - 点击"🔗 复制链接"
   - 发送给好友

4. **查看收益**
   - 累计佣金：总共赚取的佣金
   - 可提现佣金：可以申请提现的金额
   - 已提现：已经成功提现的金额
   - 总邀请人数：一级+二级+三级成员

5. **提现操作**
   - 最低提现金额：10元
   - 支持方式：支付宝/微信/银行卡
   - 填写收款信息
   - 提交后等待审核

#### 作为被邀请者（新用户）

**场景1：通过口令访问**
1. 好友分享口令到微信：`🎨 #博世界AIABC12345#...`
2. 你复制整段文字
3. 打开浏览器访问 `http://49.232.220.223/yuan`
4. **自动弹窗**提示检测到邀请码
5. 点击"立即使用"
   - 已登录：直接绑定关系
   - 未登录：跳转到注册页面

**场景2：通过链接访问**
1. 点击好友分享的链接
2. 自动携带邀请码参数
3. 注册时自动绑定邀请关系

**场景3：扫描二维码**
1. 扫描好友分享的二维码海报
2. 如果在微信内：显示"请在外部浏览器打开"提示
3. 如果在外部浏览器：自动跳转并绑定

### 佣金分配规则

#### 三级分佣比例
- **一级（直推）**：30%
- **二级（间接）**：10%
- **三级（间接）**：5%

#### 示例计算

**用户A 邀请了 用户B，用户B 邀请了 用户C，用户C 邀请了 用户D**

关系链：`A ← B ← C ← D`

当 **用户D** 充值100元：
- 用户C（一级推荐人）：获得 100 × 30% = **30元**
- 用户B（二级推荐人）：获得 100 × 10% = **10元**
- 用户A（三级推荐人）：获得 100 × 5% = **5元**

总佣金支出：45元（占订单金额的45%）

#### 可分佣的订单类型
- ✅ 余额充值
- ✅ VIP会员购买
- ✅ 预览次数购买
- ✅ 高清图下载（未来）

### 技术实现细节

#### 前端页面
- `/yuan/distribution.html` - 分销中心主页
- `/yuan/invite-code-share.html` - 口令分享页面
- `/yuan/qrcode-modal.html` - 二维码海报页面
- `/yuan/redirect.html` - 中间跳转页面
- `/yuan/clipboard-detector.js` - 剪贴板检测脚本

#### 后端API
- `GET /api/distribution/my-code` - 获取我的邀请码
- `POST /api/distribution/bind-inviter` - 绑定邀请人
- `GET /api/distribution/my-stats` - 获取我的分销数据
- `GET /api/distribution/my-team` - 获取我的团队成员
- `POST /api/distribution/withdraw` - 申请提现
- `GET /api/distribution/withdrawals` - 获取提现记录

#### 数据库表
- `user_invitations` - 邀请关系表
- `distribution_commissions` - 佣金记录表
- `user_commission_accounts` - 佣金账户表
- `distribution_withdrawals` - 提现申请表
- `distribution_config` - 分销配置表

### 口令检测工作原理

#### 自动检测机制

```javascript
// 1. 页面加载时检测剪贴板
window.addEventListener('DOMContentLoaded', () => {
    clipboardDetector.detectClipboard();
});

// 2. 页面获得焦点时检测
window.addEventListener('focus', () => {
    clipboardDetector.detectClipboard();
});

// 3. 匹配口令格式
const pattern = /#博世界AI([A-Z0-9]{8})#/;
```

#### 弹窗展示
- 检测到邀请码后自动弹出精美模态框
- 显示邀请码、佣金比例、使用说明
- 用户点击"立即使用"完成绑定

#### 防重复绑定
- LocalStorage 记录已使用的邀请码
- 同一个码只会提示一次
- 已绑定邀请人的用户不会重复绑定

### 测试清单

#### 功能测试
- [ ] 注册新用户时带邀请码参数
- [ ] 访问网站时剪贴板有邀请码口令
- [ ] 口令分享页面复制功能
- [ ] 二维码海报生成和保存
- [ ] 支付后佣金自动分配
- [ ] 佣金账户余额正确
- [ ] 提现申请提交成功
- [ ] 团队成员列表显示

#### 兼容性测试
- [ ] Chrome 浏览器
- [ ] Safari 浏览器（可能不支持剪贴板读取）
- [ ] 微信内置浏览器（中间页引导）
- [ ] 手机浏览器

#### 安全测试
- [ ] 邀请码唯一性
- [ ] 不能邀请自己
- [ ] 佣金计算准确性
- [ ] 提现金额验证
- [ ] Token 验证

### 已知限制

1. **Safari 浏览器**
   - 剪贴板权限可能被拒绝
   - 已有降级方案：手动输入入口（待开发）

2. **微信内置浏览器**
   - 链接分享可能被拦截
   - 解决方案：使用口令复制（100%防封）

3. **邀请关系**
   - 一旦绑定不可修改
   - 最多支持三级关系

### 后续优化方向

#### 功能增强
- [ ] 佣金排行榜
- [ ] 邀请奖励（首次注册奖励）
- [ ] 分享素材库
- [ ] 数据分析看板
- [ ] 手动输入邀请码入口

#### 防封加固
- [ ] 短域名（如 yw8.cn）
- [ ] 域名轮换机制
- [ ] 多个中间页备用
- [ ] PWA 应用模式

#### 运营工具
- [ ] 提现审核后台
- [ ] 佣金统计报表
- [ ] 异常账户监控
- [ ] 邀请活动配置

### 常见问题

**Q: 为什么选择口令复制而不是直接分享链接？**
A: 微信会拦截外部链接，但纯文本消息不会被拦截。口令复制是目前最稳定的分享方式。

**Q: 佣金什么时候到账？**
A: 订单支付成功后立即计算佣金，但提现需要人工审核。

**Q: 可以修改邀请人吗？**
A: 不可以。一旦绑定关系确定后不能修改，防止刷佣金。

**Q: 三级分销是否合规？**
A: 本系统为推荐奖励机制，不涉及拉人头、入会费等传销特征。但建议咨询法律顾问确保合规。

**Q: 如何防止刷佣金？**
A: 系统有多重防护：
- 邀请关系绑定后不可修改
- 同一设备/IP限制（待开发）
- 异常订单监控（待开发）
- 提现人工审核

---

## 部署完成状态

✅ 数据库表已创建
✅ 后端API已部署
✅ 前端页面已上传
✅ 口令检测已集成
✅ 服务器运行正常

**可以开始测试了！** 🎉

访问地址：
- 分销中心：http://49.232.220.223/yuan/distribution.html
- 口令分享：http://49.232.220.223/yuan/invite-code-share.html?code=测试码
- 首页（含检测）：http://49.232.220.223/yuan/

---

*最后更新：2025-12-31*
