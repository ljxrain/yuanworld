# 验证码系统实现进度

## ✅ 已完成

### 1. 数据库设计和创建
- ✅ 创建 `verification_codes` 表（验证码记录表）
- ✅ 修改 `users` 表，添加字段：
  - `phone` - 手机号
  - `phone_verified` - 手机号验证状态
  - `email_verified` - 邮箱验证状态
  - `registration_type` - 注册方式
- ✅ 在服务器执行数据库迁移

### 2. 后端服务实现
- ✅ 创建邮件发送服务 `/server/services/email.js`
  - 支持发送HTML格式验证码邮件
  - 支持三种用途：注册、登录、重置密码
  - 使用nodemailer发送邮件

- ✅ 创建验证码服务 `/server/services/verification.js`
  - 生成6位随机数字验证码
  - 频率限制检查（60秒/1小时/24小时）
  - 验证码验证逻辑
  - 清理过期验证码

- ✅ 添加API接口 `/server/routes/auth.js`
  - POST `/api/auth/send-verification-code` - 发送验证码
  - 检查目标是否已注册
  - 调用验证码服务发送

### 3. 文档
- ✅ [验证码系统设计方案.md](验证码系统设计方案.md)
- ✅ [分销系统测试方案.md](分销系统测试方案.md)
- ✅ [分销系统测试快速指南.md](分销系统测试快速指南.md)

---

## ⏳ 进行中

### 需要安装依赖
```bash
cd /opt/yuan_world
npm install nodemailer
```

### 需要配置环境变量
在服务器的 `.env` 文件中添加：
```
EMAIL_SERVICE=qq
EMAIL_HOST=smtp.qq.com
EMAIL_PORT=465
EMAIL_USER=your-email@qq.com
EMAIL_PASSWORD=your-auth-code
```

**获取QQ邮箱授权码步骤：**
1. 登录QQ邮箱 https://mail.qq.com
2. 设置 → 账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
3. 开启"POP3/SMTP服务"
4. 生成授权码（16位）
5. 将授权码填入 `EMAIL_PASSWORD`

---

## 📝 待完成

### 1. 修改注册API支持验证码（高优先级）
需要修改 `/server/routes/auth.js` 的注册接口：

```javascript
router.post('/register', async (req, res) => {
    const {
        registration_type,  // 'phone' 或 'email'
        phone,             // 手机号（type=phone时必填）
        email,             // 邮箱（type=email时必填）
        verification_code,  // 验证码（必填）
        username,
        password,
        inviter_code       // 邀请码（可选）
    } = req.body;

    // 1. 验证验证码
    const target = registration_type === 'phone' ? phone : email;
    const codeVerification = await verifyCode(target, verification_code, 'register');
    if (!codeVerification.valid) {
        return res.status(400).json({
            success: false,
            message: codeVerification.message
        });
    }

    // 2. 创建用户
    const user = await User.create({
        username,
        password,
        phone: registration_type === 'phone' ? phone : null,
        email: registration_type === 'email' ? email : null,
        phone_verified: registration_type === 'phone',
        email_verified: registration_type === 'email',
        registration_type
    });

    // 3. 如果有邀请码，建立邀请关系
    if (inviter_code) {
        // 调用分销系统绑定邀请人
    }

    // 4. 返回token和用户信息
});
```

### 2. 修改前端注册页面（高优先级）
需要修改 `/public/create.html` 的注册模态框：

**增加字段：**
- 注册方式选择（手机号/邮箱）
- 手机号输入框
- 邮箱输入框
- 验证码输入框
- 获取验证码按钮（60秒倒计时）

### 3. 完善邀请码自动绑定
- 修改邀请链接指向 `create.html?code=XXX`
- 前端读取URL参数自动填充邀请码
- 注册成功后自动调用绑定API

### 4. 实现短信验证码（中优先级）
- 注册阿里云短信服务
- 配置短信模板
- 实现短信发送函数
- 成本控制

### 5. 安全加固（低优先级）
- 添加滑动验证码（防止机器人）
- IP黑名单
- 设备指纹识别
- 异常行为监控

---

## 🧪 测试计划

### 1. 邮箱验证码测试
```bash
# 1. 发送验证码
curl -X POST http://49.232.220.223/yuan/api/auth/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{
    "type": "email",
    "target": "your-email@example.com",
    "purpose": "register"
  }'

# 2. 检查邮箱收到验证码

# 3. 使用验证码注册（前端）
```

### 2. 频率限制测试
- 连续发送验证码，验证60秒限制
- 1小时发送6次，验证频率限制
- 24小时发送11次，验证频率限制

### 3. 验证码过期测试
- 发送验证码
- 等待5分钟后使用，应该提示过期

### 4. 验证码重复使用测试
- 使用同一个验证码注册两次
- 第二次应该提示验证码已使用

---

## 📌 注意事项

1. **nodemailer依赖**：需要先安装 `npm install nodemailer`
2. **环境变量配置**：必须配置邮箱SMTP信息
3. **QQ邮箱限制**：每天最多发送500封（免费版）
4. **成本控制**：短信验证码需要付费，建议先用邮箱测试
5. **时区问题**：数据库时间戳使用UTC，显示时需要转换

---

## 🚀 下一步

1. **立即执行**：
   - 在服务器安装nodemailer依赖
   - 配置邮箱环境变量
   - 测试发送验证码API

2. **今天完成**：
   - 修改注册API支持验证码
   - 修改前端注册页面

3. **本周完成**：
   - 完整测试注册流程
   - 完善邀请码自动绑定
   - 上线验证码注册功能

4. **未来计划**：
   - 实现短信验证码
   - 添加安全防护措施
