# 博世界 - 支付功能测试说明

## 📋 已集成的支付功能

### ✅ 支持的支付方式
- **支付宝支付** (电脑端 + 手机端)
- **微信支付** (电脑端 + 手机端)

### ✅ 支持的业务类型
1. **余额充值** - 充值账户余额用于生图消费
2. **VIP会员** - 开通会员享受特权
3. **购买预览** - 购买图片预览次数

## 🌐 测试地址

### 主要页面
- **充值中心**: http://49.232.220.223/payment.html
- **支付结果页**: http://49.232.220.223/payment-result.html

### API接口
- **创建支付订单**: POST http://49.232.220.223/api/payment/create
- **支付回调(异步)**: POST http://49.232.220.223/api/payment/notify
- **支付回调(同步)**: GET http://49.232.220.223/api/payment/return
- **查询订单**: GET http://49.232.220.223/api/payment/order/{订单号}
- **订单列表**: GET http://49.232.220.223/api/payment/orders

## 🔧 测试步骤

### 1. 电脑端测试支付宝

#### 步骤：
1. 打开浏览器访问: http://49.232.220.223/payment.html
2. 选择一个充值套餐（建议选择10元测试）
3. 选择"支付宝"作为支付方式
4. 点击"立即充值"按钮
5. 会跳转到支付宝收银台页面
6. 使用支付宝扫码完成支付
7. 支付完成后会自动跳转到结果页面

#### 预期结果：
- ✅ 成功跳转到支付宝支付页面
- ✅ 可以看到订单金额和商品名称
- ✅ 扫码支付成功
- ✅ 自动跳转到支付结果页
- ✅ 显示"支付成功"状态
- ✅ 账户余额/VIP状态已更新

### 2. 电脑端测试微信支付

#### 步骤：
1. 访问: http://49.232.220.223/payment.html
2. 选择一个VIP套餐（建议选择30元月度会员）
3. 选择"微信支付"作为支付方式
4. 点击"开通VIP"按钮
5. 会显示微信支付二维码
6. 使用微信扫码完成支付
7. 支付完成后会自动跳转到结果页面

#### 预期结果：
- ✅ 成功显示微信支付二维码
- ✅ 可以看到订单金额
- ✅ 扫码支付成功
- ✅ 自动跳转到支付结果页
- ✅ 显示"支付成功"状态
- ✅ VIP状态已开通

### 3. 手机端测试支付宝

#### 步骤：
1. 用手机浏览器访问: http://49.232.220.223/payment.html
2. 选择"购买预览"标签
3. 选择一个预览套餐（5元/10次）
4. 选择"支付宝"
5. 点击"立即购买"
6. 会自动唤起支付宝APP或打开支付宝H5页面
7. 在支付宝中完成支付
8. 支付完成后返回页面

#### 预期结果：
- ✅ 移动端页面适配良好
- ✅ 自动唤起支付宝APP（如已安装）
- ✅ 或打开支付宝H5支付页面
- ✅ 支付成功
- ✅ 预览次数已增加

### 4. 手机端测试微信支付

#### 步骤：
1. 用手机微信内访问: http://49.232.220.223/payment.html
2. 选择任意充值套餐
3. 选择"微信支付"
4. 点击充值按钮
5. 会调起微信支付
6. 输入密码完成支付

#### 预期结果：
- ✅ 在微信内可以正常访问
- ✅ 调起微信支付正常
- ✅ 支付流程顺畅
- ✅ 支付成功
- ✅ 余额已充值

## 📊 测试数据查询

### 查看支付订单
登录后访问个人中心，可以查看：
- 支付订单历史
- 订单状态
- 支付时间
- 支付金额

### 数据库查询（服务器端）
```bash
# SSH连接服务器
ssh yuan

# 查询支付订单
sudo -u postgres psql -d yuan_world -c "SELECT * FROM payment_orders ORDER BY created_at DESC LIMIT 10;"

# 查询支付回调日志
sudo -u postgres psql -d yuan_world -c "SELECT * FROM payment_callbacks ORDER BY created_at DESC LIMIT 10;"
```

## 🐛 问题排查

### 1. 支付创建失败
**检查项：**
- 用户是否已登录？
- 网络连接是否正常？
- 查看浏览器控制台错误信息

**解决方案：**
```bash
# 查看服务器日志
ssh yuan 'pm2 logs yuan-world-app --lines 50'
```

### 2. 支付完成但未到账
**检查项：**
- 查看订单状态是否为 "paid"
- 检查回调日志是否记录
- 验证签名是否通过

**解决方案：**
```bash
# 查询订单状态
ssh yuan "sudo -u postgres psql -d yuan_world -c \"SELECT out_trade_no, status, notify_status, amount FROM payment_orders WHERE out_trade_no='订单号';\""

# 查询回调日志
ssh yuan "sudo -u postgres psql -d yuan_world -c \"SELECT * FROM payment_callbacks WHERE out_trade_no='订单号';\""
```

### 3. 回调地址无法访问
**检查项：**
- 服务器防火墙是否开放80端口
- Nginx配置是否正确
- 应用是否正常运行

**解决方案：**
```bash
# 检查服务状态
ssh yuan 'pm2 status && systemctl status nginx'

# 测试API是否可访问
curl http://49.232.220.223/api/payment/notify
```

## 📝 测试清单

### 电脑端测试
- [ ] 支付宝 - 余额充值（10元）
- [ ] 支付宝 - VIP会员（30元）
- [ ] 支付宝 - 购买预览（5元）
- [ ] 微信支付 - 余额充值（10元）
- [ ] 微信支付 - VIP会员（30元）
- [ ] 微信支付 - 购买预览（5元）

### 手机端测试
- [ ] 支付宝 - 余额充值（手机浏览器）
- [ ] 支付宝 - VIP会员（手机浏览器）
- [ ] 微信支付 - 余额充值（微信内浏览器）
- [ ] 微信支付 - VIP会员（微信内浏览器）

### 功能测试
- [ ] 订单创建成功
- [ ] 支付跳转正常
- [ ] 支付完成回调
- [ ] 账户余额更新
- [ ] VIP状态更新
- [ ] 预览次数更新
- [ ] 订单查询功能
- [ ] 订单列表显示

## 🔐 七相支付配置信息

```
商户ID: 2947
密钥: 22o7o0C9yAo3cJA912216coz7o277c92
回调地址(异步): http://49.232.220.223/api/payment/notify
回调地址(同步): http://49.232.220.223/payment-result.html
```

## 📞 技术支持

如遇到问题：
1. 查看服务器日志: `ssh yuan 'pm2 logs yuan-world-app'`
2. 查看Nginx日志: `ssh yuan 'tail -f /var/log/nginx/error.log'`
3. 检查数据库数据: 使用上述SQL查询命令

## ✅ 部署完成状态

- [x] 七相支付SDK集成
- [x] 支付路由创建
- [x] 数据库表创建
- [x] 前端支付页面
- [x] 支付结果页面
- [x] 环境变量配置
- [x] 服务器部署完成
- [x] 应用重启成功
- [ ] **待测试：电脑端支付宝**
- [ ] **待测试：电脑端微信**
- [ ] **待测试：手机端支付宝**
- [ ] **待测试：手机端微信**

---

**创建时间**: 2025-12-30 18:05
**服务器地址**: http://49.232.220.223
**充值页面**: http://49.232.220.223/payment.html
